<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒ­ãƒ¼ãƒå­—ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒ»ãƒã‚¹ã‚¿ãƒ¼ï¼ˆã‚­ãƒƒã‚ºï¼‰</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* ã‚­ãƒƒã‚ºç‰ˆã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ */
            --primary-color: #ff5252; /* èµ¤ */
            --accent-color: #4ECDC4;  /* æ°´è‰² */
            --master-gold: #ffca28;   /* ã‚´ãƒ¼ãƒ«ãƒ‰ */
            --text-color: #444;
            --bg-pattern: #fff8e1;
            --key-shadow: #b0bec5;
            
            /* è¦–èªæ€§å‘ä¸Šã®ãŸã‚ã®æ¿ƒã„è‰²å®šç¾© */
            --text-dark: #37474f;   /* ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ–‡å­—ç”¨ */
            --text-on-gold: #3e2723; /* ã‚´ãƒ¼ãƒ«ãƒ‰èƒŒæ™¯ç”¨ï¼ˆã“ã’èŒ¶ï¼‰ */
        }
        body { 
            font-family: 'Zen Maru Gothic', 'Hiragino Maru Gothic ProN', 'Rounded Mplus 1c', sans-serif; 
            text-align: center; 
            margin: 0; padding: 0;
            color: var(--text-color); 
            overflow: hidden; height: 100vh; width: 100vw;
            display: flex; align-items: center; justify-content: center;
            background-color: var(--bg-pattern);
            background-image: radial-gradient(#ffe082 20%, transparent 20%), radial-gradient(#ffcc80 20%, transparent 20%);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
            user-select: none;
        }
        
        #game-container { 
            background: rgba(255, 255, 255, 0.98); 
            width: 96%; max-width: 1100px; 
            height: 94vh; max-height: 720px;
            margin: auto; padding: 15px; box-sizing: border-box;
            border: 8px solid var(--master-gold); 
            border-radius: 24px; 
            box-shadow: 0 10px 0 rgba(0,0,0,0.1);
            position: relative; display: flex; flex-direction: column; justify-content: space-between; align-items: center;
            transition: border-color 0.1s, background-color 0.1s;
        }

        /* æ¿€ã—ã„æºã‚Œã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes shake-hard {
            0% { transform: translate(0, 0) rotate(0deg); }
            20% { transform: translate(-6px, 2px) rotate(-1deg); }
            40% { transform: translate(6px, -2px) rotate(1deg); }
            60% { transform: translate(-4px, 1px) rotate(0deg); }
            80% { transform: translate(4px, -1px) rotate(0deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        /* ãƒŸã‚¹æ™‚ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        #game-container.miss-effect { 
            background-color: #ffcdd2 !important; 
            border-color: #e53935 !important;
            box-shadow: 0 0 30px rgba(255, 82, 82, 0.5) !important;
            animation: shake-hard 0.3s ease-out both;
        }

        /* å³ä¸Šã‚¢ã‚¤ã‚³ãƒ³ç¾¤ */
        .top-right-btns { 
            position: fixed; 
            top: 15px; right: 20px; 
            display: flex; gap: 12px; 
            z-index: 22000; 
        }
        .icon-btn { 
            font-size: 1.5rem; cursor: pointer; opacity: 1; user-select: none; transition: 0.2s; 
            width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; 
            background: #fff; border-radius: 50%; 
            box-shadow: 0 3px 8px rgba(0,0,0,0.2); 
            border: 2px solid #ccc; 
            color: #555; 
        }
        .icon-btn:hover { transform: scale(1.1); border-color: var(--master-gold); color: var(--master-gold); box-shadow: 0 5px 12px rgba(0,0,0,0.3); }

        /* --- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ï¼‰ --- */
        #overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.98);
            border-radius: 16px; display: flex; flex-direction: column; 
            align-items: center; z-index: 5000; 
            padding: 10px; box-sizing: border-box; 
            overflow-y: auto;
        }

        .title-area { margin: 10px 0 5px; text-align: center; }
        #overlay-title { 
            margin: 0; font-size: 3rem; color: var(--primary-color); 
            text-shadow: 2px 2px 0 var(--master-gold); line-height: 1.2;
        }
        .subtitle { font-size: 1.2rem; color: #777; font-weight: bold; margin-top: 5px;}

        /* éŠã³æ–¹ãƒœã‚¿ãƒ³ */
        .btn-howto {
            background: var(--accent-color); color: white; border: none;
            padding: 8px 24px; border-radius: 20px; font-weight: bold; font-size: 1rem;
            cursor: pointer; margin-bottom: 10px; font-family: inherit;
            box-shadow: 0 3px 0 #26a69a; transition: 0.2s;
        }
        .btn-howto:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn-howto:active { transform: translateY(2px); box-shadow: 0 1px 0 #26a69a; }

        /* è¨­å®šã‚¨ãƒªã‚¢ */
        .settings-area {
            display: flex; gap: 20px; margin-bottom: 15px; 
            font-weight: bold; font-size: 1.1rem; color: #555; 
            background: #fff; padding: 10px 30px; border-radius: 50px; 
            border: 2px solid #eee; box-shadow: 0 4px 0 #eee;
            align-items: center; justify-content: center; flex-wrap: wrap;
        }
        .toggle-wrap { display: flex; align-items: center; cursor: pointer; color: #555; user-select: none; }
        .toggle-label { margin-left: 6px; }
        input[type="checkbox"] { transform: scale(1.3); cursor: pointer; margin: 0; accent-color: var(--accent-color); }

        /* å¤§æ–‡å­—å°æ–‡å­—ã‚¹ã‚¤ãƒƒãƒ */
        .case-switch-group {
            display: flex; align-items: center; gap: 10px; margin-left: 5px; 
            border-left: 2px solid #eee; padding-left: 20px;
        }
        .case-label { 
            font-family: 'Courier New', monospace; font-weight: bold; 
            transition: 0.2s; color: #ccc; font-size: 1.1rem;
        }
        .case-label.active { 
            color: var(--text-dark); transform: scale(1.3); 
            text-shadow: 0 2px 0 rgba(0,0,0,0.1); 
            font-weight: 900;
        }
        
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        .reset-btn {
            background: transparent; border: none; border-left: 2px solid #eee;
            padding-left: 15px; margin-left: 5px;
            cursor: pointer; font-size: 1.4rem; color: #d32f2f;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .reset-btn:hover { transform: scale(1.2); }

        /* ãƒ¢ãƒ¼ãƒ‰é¸æŠãƒœã‚¿ãƒ³ */
        .btn-container { display: flex; gap: 20px; justify-content: center; width: 100%; max-width: 800px; flex-wrap: wrap; margin-bottom: 15px;}
        .mode-btn { 
            flex: 1; min-width: 260px; padding: 15px; 
            border-radius: 20px; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 15px;
            color: white; font-family: inherit; transition: 0.2s;
            box-shadow: 0 6px 0 rgba(0,0,0,0.15); position: relative;
        }
        .mode-btn:hover { transform: translateY(-4px); box-shadow: 0 10px 0 rgba(0,0,0,0.15); filter: brightness(1.05); }
        .mode-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 rgba(0,0,0,0.15); }
        
        .btn-practice { background: linear-gradient(135deg, #4ECDC4, #26a69a); }
        .btn-master { background: linear-gradient(135deg, #FF6B6B, #d32f2f); }

        .btn-icon { font-size: 2.5rem; background: rgba(255,255,255,0.2); border-radius: 50%; width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; }
        .btn-text { text-align: left; }
        .btn-title { font-size: 1.6rem; font-weight: 900; display: block; }
        .btn-desc { font-size: 0.9rem; margin-top: 2px; display: block; opacity: 0.9; }

        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚¨ãƒªã‚¢ */
        #rankings-area { 
            width: 90%; max-width: 340px; background: #fff9c4; 
            padding: 10px 15px; border-radius: 16px; border: 2px solid #fbc02d;
            margin-top: 5px;
            max-height: 150px; overflow-y: auto;
            scrollbar-width: thin; scrollbar-color: #f9a825 transparent;
        }
        .rank-title { font-weight: bold; border-bottom: 2px dashed #f9a825; margin-bottom: 5px; color: #f57f17; text-align: center; }
        .rank-row { display: flex; justify-content: space-between; padding: 1px 8px; border-bottom: 1px dotted #fbc02d; color: #555; }
        .rank-row:last-child { border-bottom: none; }
        
        .copyright-link { margin-top: 10px; font-size: 0.8rem; color: #aaa; text-align: center; cursor: pointer; text-decoration: underline; }
        .copyright-link:hover { color: var(--primary-color); }

        /* --- ãƒãƒ¼ã‚ºï¼ˆä¸­æ–­ï¼‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ --- */
        #pause-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 10000;
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            backdrop-filter: blur(2px);
            border-radius: 16px;
        }
        .pause-msg {
            font-size: 2rem; font-weight: 900; color: #555;
            background: white; padding: 20px 50px; border-radius: 50px;
            border: 5px solid var(--accent-color);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: transform 0.2s;
            animation: pulse 2s infinite;
        }
        .pause-msg:hover { transform: scale(1.05); }
        @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.05);} 100%{transform:scale(1);} }

        /* çµæœç”»é¢ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ */
        #result-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 20000;
            display: none; justify-content: center; align-items: center;
        }
        .result-content {
            background: white; padding: 30px; border-radius: 30px; 
            border: 8px solid var(--master-gold); text-align: center; 
            min-width: 450px; max-width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .my-rank { 
            background: #fff0f5; 
            border: 2px solid #ff4081; 
            color: #d81b60; font-weight: bold;
            border-radius: 8px;
        }
        .my-rank::after { content: " ğŸ‘ˆ ã‚ãªãŸ"; font-size: 0.8em; margin-left: 5px; background:#ff4081; color:#fff; padding:2px 6px; border-radius:10px; }

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« (éŠã³æ–¹ãƒ»ã‚³ãƒ³ã‚»ãƒ—ãƒˆ) --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 24000;
            justify-content: center; align-items: center;
        }
        .modal-box {
            background: #fff; width: 90%; max-width: 650px; max-height: 85vh;
            border-radius: 20px; border: 6px solid var(--accent-color);
            padding: 25px; overflow-y: auto; text-align: left;
            position: relative; animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            word-wrap: break-word; overflow-wrap: break-word;
        }
        .modal-box.concept-mode { border-color: var(--primary-color); }

        .modal-close {
            position: absolute; top: 10px; right: 15px; font-size: 2rem;
            color: #ccc; cursor: pointer; line-height: 1; font-weight: bold;
        }
        .modal-close:hover { color: var(--primary-color); }

        .howto-h2 { text-align: center; color: #fff; background: #00897b; border-radius: 30px; padding: 8px 25px; margin: 0 auto 20px auto; width: fit-content; box-shadow: 0 4px 0 #00695c; font-size: 1.4rem; }
        .concept-h2 { text-align: center; color: #c62828; border-bottom: 3px dashed #ffcdd2; padding-bottom: 10px; margin-top: 0; }

        .howto-section { background: #e0f2f1; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .howto-section h3 { margin: 0 0 10px 0; color: #00695c; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; border-bottom: 2px solid rgba(0,105,92,0.2); padding-bottom: 5px; }
        .howto-item { display: flex; align-items: start; gap: 10px; margin-bottom: 10px; line-height: 1.5; font-size: 0.95rem; }
        .howto-icon { font-size: 1.6rem; width: 40px; text-align: center; flex-shrink: 0; background: #fff; border-radius: 50%; height: 40px; display: flex; justify-content: center; align-items: center; }
        .badge-param { display: inline-block; background: #26a69a; color: #fff; padding: 2px 10px; border-radius: 12px; font-weight: bold; font-size: 0.85rem; margin-bottom: 3px; }

        .concept-list { font-size: 0.95rem; line-height: 1.6; color: #444; padding-left: 20px; }
        .concept-list li { margin-bottom: 8px; }
        .license-box { background: #fff8e1; padding: 15px; border-radius: 10px; text-align: center; margin-top: 20px; font-weight: bold; color: #ef6c00; border: 2px dashed #ffb74d; }

        @keyframes popIn { 0%{transform: scale(0.5); opacity: 0;} 60%{transform: scale(1.05); opacity: 1;} 100%{transform: scale(1); opacity: 1;} }

        /* --- ã‚²ãƒ¼ãƒ ç”»é¢ --- */
        .info-bar { 
            display: flex; justify-content: center; align-items: center; 
            width: 100%; position: relative; font-size: 1.3rem; font-weight: bold; color: #555; 
            margin-bottom: 8px; min-height: 60px; 
        }
        
        .timer-badge { 
            background: var(--master-gold); color: var(--text-on-gold); 
            padding: 5px 30px; border-radius: 40px; 
            box-shadow: 0 5px 0 #f57f17; font-size: 2.2rem; line-height: 1.1; 
            min-width: 200px; text-align: center; z-index: 5;
        }

        .remain-status {
            position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
            font-size: 1.2rem; color: #555; background: rgba(255,255,255,0.8);
            padding: 5px 10px; border-radius: 10px;
        }

        .display-area {
            flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%;
            background: #fff; border-radius: 20px; margin: 10px 0; border: 4px dashed #ffe082;
            min-height: 150px;
        }
        #target-emoji { font-size: 5rem; line-height: 1.2; margin-top: -5px; }
        #target-kana { font-size: 3.5rem; font-weight: 900; color: #333; line-height: 1; margin: 5px 0; }
        
        /* æ‹¡å¤§ã—ãŸæ–‡å­—ã‚µã‚¤ã‚º */
        #target-roma { 
            font-size: 4.8rem; font-weight: bold; color: #cfd8dc; 
            font-family: 'Courier New', monospace; letter-spacing: 2px; line-height: 1.1;
        }
        .typed { color: var(--primary-color); }
        .next-char { color: #0288d1; text-decoration: underline; text-decoration-thickness: 5px; text-underline-offset: 6px; }

        /* ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ */
        #keyboard { 
            display: flex; flex-direction: column; gap: 6px; 
            width: 100%; padding: 10px 5px; 
            background: #eceff1; border-radius: 16px; 
            box-sizing: border-box; flex-shrink: 0;
        }
        .kb-row { display: flex; justify-content: center; gap: 6px; width: 100%; }
        
        .key { 
            width: 8%; max-width: 50px; aspect-ratio: 1/1;
            display: flex; justify-content: center; align-items: center;
            background: #fff; border-radius: 8px; 
            font-weight: bold; font-size: 1.1rem; 
            color: var(--text-dark); 
            box-shadow: 0 3px 0 var(--key-shadow);
            position: relative; transition: all 0.1s;
        }
        .key.active { 
            background: var(--master-gold) !important; 
            color: var(--text-on-gold); 
            box-shadow: 0 2px 0 #f57f17; 
            transform: translateY(3px); 
        }
        .key.home { border: 2px solid var(--primary-color); }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¾®èª¿æ•´ */
        @media (max-width: 900px) {
            #target-roma { font-size: 3.5rem; }
        }
        @media (max-height: 660px) {
            #target-emoji { font-size: 3.5rem; }
            #target-kana { font-size: 2.8rem; }
            #target-roma { font-size: 3rem; }
            .mode-btn { padding: 10px; min-width: 200px; }
            .btn-icon { width: 40px; height: 40px; font-size: 2rem; }
            .btn-title { font-size: 1.4rem; }
            #overlay-title { font-size: 2.2rem; }
            .timer-badge { font-size: 1.8rem; padding: 5px 20px; min-width: 160px; }
            .settings-area { padding: 5px 15px; }
            .menu-ranking-box { max-height: 80px; }
        }
    </style>
</head>
<body onload="init()">

    <div class="top-right-btns">
        <div class="icon-btn" onclick="toggleFullScreen()" title="ãœã‚“ãŒã‚ã‚“">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width:24px; height:24px;">
                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
            </svg>
        </div>
        <div class="icon-btn" id="mute-btn" onclick="toggleMute()" title="ãŠã¨">ğŸ”Š</div>
    </div>

    <div id="game-container">
        
        <div id="pause-overlay" onclick="resumeGame()">
            <div class="pause-msg">â–¶ ã‚¯ãƒªãƒƒã‚¯ã—ã¦ ã¤ã¥ã‘ã‚‹</div>
        </div>

        <div id="modal-howto-overlay" class="modal-overlay" onclick="closeModal(event)">
            <div class="modal-box">
                <span class="modal-close" onclick="closeModalBtn()">Ã—</span>
                <h2 class="howto-h2">ğŸ“– ã‚ãã³ã‹ãŸãƒ»ã›ã¤ã‚ã„</h2>
                
                <div class="howto-section">
                    <h3>ã‚ãã³ã‹ãŸ</h3>
                    
                    <div class="howto-item">
                        <span class="howto-icon">ğŸ”°</span>
                        <div class="howto-text">
                            <span class="badge-param">ã‚Œã‚“ã—ã‚…ã†</span><br>
                            10ã‚‚ã‚“ ã ã‘ã® ã¿ã˜ã‹ã„ ã‚³ãƒ¼ã‚¹ã ã‚ˆã€‚ã¾ãšã¯ ã“ã“ã§ ã‚Œã‚“ã—ã‚…ã† ã—ã‚ˆã†ï¼
                        </div>
                    </div>

                    <div class="howto-item">
                        <span class="howto-icon">ğŸ‘‘</span>
                        <div class="howto-text">
                            <span class="badge-param" style="background:#ef5350;">ãƒã‚¹ã‚¿ãƒ¼</span><br>
                            30ã‚‚ã‚“ã® ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ï¼ ã‚¯ãƒªã‚¢ã‚¿ã‚¤ãƒ ãŒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã« ã®ã“ã‚‹ã‚ˆï¼
                        </div>
                    </div>
                </div>

                <div class="howto-section" style="background:#fffde7;">
                    <h3 style="color:#f57f17;">ã›ã£ã¦ã„ãƒ»ã¿ã‹ãŸ</h3>
                    
                    <div class="howto-item">
                        <span class="howto-icon">ğŸ”Š</span>
                        <div class="howto-text">
                            <strong>ãŠã¨</strong><br>
                            ã‚¹ã‚¤ãƒƒãƒã§ ãŠã¨ã‚’ ãªã‚‰ã—ãŸã‚Š ã‘ã—ãŸã‚Š ã§ãã‚‹ã‚ˆã€‚
                        </div>
                    </div>

                    <div class="howto-item">
                        <span class="howto-icon">ğŸ”¤</span>
                        <div class="howto-text">
                            <strong>ã²ã‚‡ã†ã˜</strong><br>
                            ã€Œabc (ã“ã‚‚ã˜)ã€ã¨ã€ŒABC (ãŠãŠã‚‚ã˜)ã€ã‚’ ã‹ãˆã‚‰ã‚Œã‚‹ã‚ˆã€‚
                        </div>
                    </div>

                    <div class="howto-item">
                        <span class="howto-icon">ğŸ—‘ï¸</span>
                        <div class="howto-text">
                            <strong>ãã‚ãã‚’ ã‘ã™</strong><br>
                            ã€Œã”ã¿ã°ã“ã€ãƒœã‚¿ãƒ³ã‚’ ãŠã™ã¨ã€ã™ã¹ã¦ã® ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ ã‘ã›ã‚‹ã‚ˆã€‚
                        </div>
                    </div>

                    <div class="howto-item">
                        <span class="howto-icon">ğŸ‘€ï¸</span>
                        <div class="howto-text">
                            <strong>ãƒ­ãƒ¼ãƒå­—</strong><br>
                            ã¾ã‚“ãªã‹ã® ã‚‚ã˜ã‚’ ã¿ã¦ ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã—ã‚ˆã†ã€‚
                        </div>
                    </div>

                    <div class="howto-item">
                        <span class="howto-icon">âŒ¨ï¸</span>
                        <div class="howto-text">
                            <strong>ã‚¬ã‚¤ãƒ‰</strong><br>
                            ã¤ãã« ãŠã™ ã‚­ãƒ¼ãŒ ã²ã‹ã£ã¦ ã°ã—ã‚‡ã‚’ ãŠã—ãˆã¦ ãã‚Œã‚‹ã‚ˆã€‚
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div id="modal-concept-overlay" class="modal-overlay" onclick="closeModal(event)">
            <div class="modal-box concept-mode">
                <span class="modal-close" onclick="closeModalBtn()">Ã—</span>
                <h2 class="concept-h2">ğŸ’¡ ã“ã®ãƒ„ãƒ¼ãƒ«ã«ã¤ã„ã¦</h2>
                
                <ul class="concept-list">
                    <li><strong>ğŸ« æ¥½ã—ãç¿’å¾—</strong><br>å°å­¦æ ¡ä½å­¦å¹´ã‹ã‚‰ã€éŠã³æ„Ÿè¦šã§ãƒ­ãƒ¼ãƒå­—å…¥åŠ›ã‚’è¦šãˆã‚‰ã‚Œã¾ã™ã€‚ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ã‚„ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºãªã©ã®ã‚²ãƒ¼ãƒ è¦ç´ ã‚’å–ã‚Šå…¥ã‚Œã€æ¥½ã—ãç¶™ç¶šã§ãã‚‹ã‚ˆã†ã«è¨­è¨ˆã—ã¾ã—ãŸã€‚</li>
                    <li><strong>ğŸ® ã‚²ãƒ¼ãƒ æ„Ÿè¦šã§æ¥½ã—ãç¿’å¾—</strong><br>å°å­¦æ ¡ä½å­¦å¹´ã‹ã‚‰ã€éŠã³æ„Ÿè¦šã§ãƒ­ãƒ¼ãƒå­—å…¥åŠ›ã‚’è¦šãˆã‚‰ã‚Œã¾ã™ã€‚èŠ±ç«ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚„åŠ¹æœéŸ³ã€ã‚¹ã‚³ã‚¢ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãªã©ã®ã‚²ãƒ¼ãƒ è¦ç´ ã‚’å–ã‚Šå…¥ã‚Œã€æ¥½ã—ãç¶™ç¶šã§ãã‚‹ã‚ˆã†ã«è¨­è¨ˆã—ã¾ã—ãŸã€‚</li>
                    <li><strong>ğŸ’» å­¦æ ¡ã®ç«¯æœ«ã«å¯¾å¿œ</strong><br>GIGAã‚¹ã‚¯ãƒ¼ãƒ«æ§‹æƒ³ã®ç«¯æœ«ï¼ˆWindows / Chromebookï¼‰ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œã—ã¾ã™ã€‚</li>
                    <li><strong>ğŸ›œ ãƒãƒƒãƒˆä¸è¦</strong><br>ã“ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚Œã°ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆãŒãªã„ç’°å¢ƒã§ã‚‚å®¶åº­ã‚„å­¦æ ¡ã§éŠã¹ã¾ã™ã€‚</li>
                    <li><strong>âœ¨ æŸ”è»Ÿãªå…¥åŠ›å¯¾å¿œ</strong><br>ã€Œã— (SI/SHI)ã€ã€Œã¤ (TU/TSU)ã€ã€Œã‚“ (N/NN)ã€ãªã©ã€è¨“ä»¤å¼ãƒ»ãƒ˜ãƒœãƒ³å¼ã®ä¸¡æ–¹ã«å¯¾å¿œã—ãŸå…¥åŠ›åˆ¤å®šæ©Ÿèƒ½ã‚’æ­è¼‰ã—ã¦ã„ã¾ã™ã€‚</li>
                    <li><strong>ğŸ”„ è±Šå¯Œãªå•é¡Œã¨ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œ</strong><br>200èªä»¥ä¸Šã®å˜èªã‹ã‚‰æ¯å›ãƒ©ãƒ³ãƒ€ãƒ ã«å•é¡ŒãŒé¸ã°ã‚Œã‚‹ãŸã‚ã€é£½ããšã«ç¹°ã‚Šè¿”ã—ç·´ç¿’ã§ãã¾ã™ã€‚</li>
                    <li><strong>ğŸ¦„ ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ‰çµµæ–‡å­—ã¨ã‚·ãƒ³ãƒ—ãƒ«ãƒ»äº’æ›æ€§</strong><br>ã‚¤ãƒ©ã‚¹ãƒˆã‚„ã‚¢ã‚¤ã‚³ãƒ³ã¯ç”»åƒç´ æã‚’ä½¿ã‚ãšã€Unicodeçµµæ–‡å­—ã®ã¿ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚å‹•ä½œãŒè»½ãã€ç•°ãªã‚‹ãƒ‡ãƒã‚¤ã‚¹ã‚„OSé–“ã§ã‚‚é«˜ã„äº’æ›æ€§ãŒã‚ã‚Šã€ãƒ•ã‚¡ã‚¤ãƒ«ã®ç ´æã‚‚èµ·ãã«ãã„è¨­è¨ˆã§ã™ã€‚</li>
                    <li style="color:#d32f2f;"><strong>âš ï¸ æ³¨æ„ç‚¹</strong><br>æœ¬ãƒ„ãƒ¼ãƒ«ã¯ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’ç”¨ã®ãŸã‚ã€ç‰©ç†ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§ã®æ“ä½œã‚’å‰æã¨ã—ã¦ã„ã¾ã™ã€‚ç”»é¢ä¸Šã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼ˆã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼‰ã«ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚</li>
                </ul>

                <div class="license-box">
                    å•†ç”¨åˆ©ç”¨ã¯ä¸å¯ã§ã™ãŒã€é…å¸ƒãƒ»åˆ©ç”¨ãƒ»æ”¹å¤‰ã¯è‡ªç”±ã§ã™ã€‚<br>
                    (Non-commercial use only. Free to distribute, use, and modify)
                </div>

            </div>
        </div>

        <div id="result-overlay" class="modal-overlay" style="z-index: 20000;">
            <div class="result-content">
                <h2 id="res-title" style="font-size:2.5rem; margin:0; color:var(--master-gold);">FINISH!</h2>
                <div id="res-msg" style="font-size:1.2rem; font-weight:bold; margin:10px 0;"></div>
                <div style="text-align:left; max-height:200px; overflow-y:auto; border:2px dashed #eee; padding:10px; margin:10px 0; border-radius:10px; background:#fff8e1;">
                    <div style="font-weight:bold; color:#f57f17; border-bottom:1px solid #fbc02d; margin-bottom:5px;">ğŸ† ãƒã‚¹ã‚¿ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
                    <div id="res-ranking-list"></div>
                </div>
                <div style="display:flex; gap:10px; justify-content:center; margin-top:15px;">
                    <button class="mode-btn" style="background:#90a4ae; padding:10px 20px; font-size:1.1rem; flex:1;" onclick="backToMenu()">ğŸ  ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
                    <button class="mode-btn" style="background:var(--accent-color); padding:10px 20px; font-size:1.1rem; flex:1.5;" onclick="startGame(currentModeCount)">ã‚‚ã†ã„ã¡ã©</button>
                </div>
            </div>
        </div>

        <div id="overlay">
            <div class="title-area">
                <h1 id="overlay-title">ãƒ­ãƒ¼ãƒå­—<br>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒ»ãƒã‚¹ã‚¿ãƒ¼</h1>
                <div class="subtitle">ã‚ã–ã›ï¼ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç‹ï¼ˆã‚­ãƒƒã‚ºï¼‰</div>
            </div>
            
            <button class="btn-howto" onclick="showHowto()">ğŸ“– ã‚ãã³ã‹ãŸãƒ»ã›ã¤ã‚ã„</button>

            <div class="settings-area">
                <label class="toggle-wrap" title="æ‰“éµéŸ³ã‚„æ­£è§£éŸ³">
                    <input type="checkbox" id="se-toggle" checked>
                    <span class="toggle-label">ğŸ”Š ãŠã¨</span>
                </label>
                
                <div class="case-switch-group">
                    <span style="font-size:0.9em; margin-right:5px;">ã²ã‚‡ã†ã˜:</span>
                    <span id="label-abc" class="case-label active">abc</span>
                    <label class="switch" style="margin:0 5px;">
                        <input type="checkbox" id="case-switch" onchange="updateDisplay()">
                        <span class="slider round"></span>
                    </label>
                    <span id="label-ABC" class="case-label">ABC</span>
                </div>

                <button class="reset-btn" onclick="resetRankings()" title="ãã‚ãã‚’ã‘ã™">ğŸ—‘ï¸</button>
            </div>

            <div id="mode-buttons" class="btn-container">
                <button class="mode-btn btn-practice" onclick="startGame(10)">
                    <div class="btn-icon">ğŸ”°</div>
                    <div class="btn-text">
                        <span class="btn-title">ã‚Œã‚“ã—ã‚…ã†</span>
                        <span class="btn-desc">10ã‚‚ã‚“ (ã‹ã‚“ãŸã‚“)</span>
                    </div>
                </button>
                <button class="mode-btn btn-master" onclick="startGame(30)">
                    <div class="btn-icon">ğŸ‘‘</div>
                    <div class="btn-text">
                        <span class="btn-title">ãƒã‚¹ã‚¿ãƒ¼</span>
                        <span class="btn-desc">30ã‚‚ã‚“ (ãã‚ãã®ã“ã‚‹)</span>
                    </div>
                </button>
            </div>
            
            <div id="rankings-area">
                <div class="rank-title">
                    <span>ğŸ‘‘ ãƒã‚¹ã‚¿ãƒ¼(30ã‚‚ã‚“) ãƒ™ã‚¹ãƒˆ5</span>
                </div>
                <div id="rank-list">ãã‚ããªã—</div>
            </div>

            <div class="copyright-link" onclick="showConcept()">
                Â© 2026 [A.K] (ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°)
            </div>
        </div>

        <div class="info-bar">
            <div class="remain-status">
                ã®ã“ã‚Š: <span id="remain" style="color:var(--primary-color); font-size:1.6rem;">0</span> ã‚‚ã‚“
            </div>
            <div class="timer-badge" id="timer">0.0ã³ã‚‡ã†</div>
        </div>
        
        <div class="display-area">
            <div id="target-emoji">ğŸš€</div>
            <div id="target-kana">...</div>
            <div id="target-roma">...</div>
        </div>

        <div id="keyboard"></div>
    </div>

    <script>
        const romaTable = {
            "ã‚":"A","ã„":"I","ã†":"U","ãˆ":"E","ãŠ":"O","ã‹":"KA","ã":"KI","ã":"KU","ã‘":"KE","ã“":"KO","ã•":"SA","ã—":"SI","ã™":"SU","ã›":"SE","ã":"SO",
            "ãŸ":"TA","ã¡":"TI","ã¤":"TU","ã¦":"TE","ã¨":"TO","ãª":"NA","ã«":"NI","ã¬":"NU","ã­":"NE","ã®":"NO","ã¯":"HA","ã²":"HI","ãµ":"HU","ã¸":"HE","ã»":"HO",
            "ã¾":"MA","ã¿":"MI","ã‚€":"MU","ã‚":"ME","ã‚‚":"MO","ã‚„":"YA","ã‚†":"YU","ã‚ˆ":"YO","ã‚‰":"RA","ã‚Š":"RI","ã‚‹":"RU","ã‚Œ":"RE","ã‚":"RO","ã‚":"WA","ã‚’":"WO","ã‚“":"NN",
            "ãŒ":"GA","ã":"GI","ã":"GU","ã’":"GE","ã”":"GO","ã–":"ZA","ã˜":"ZI","ãš":"ZU","ãœ":"ZE","ã":"ZO","ã ":"DA","ã¢":"DI","ã¥":"DU","ã§":"DE","ã©":"DO",
            "ã°":"BA","ã³":"BI","ã¶":"BU","ã¹":"BE","ã¼":"BO","ã±":"PA","ã´":"PI","ã·":"PU","ãº":"PE","ã½":"PO",
            "ãã‚ƒ":"KYA","ãã‚…":"KYU","ãã‚‡":"KYO","ã—ã‚ƒ":"SYA","ã—ã‚…":"SYU","ã—ã‚‡":"SYO","ã¡ã‚ƒ":"TYA","ã¡ã‚…":"TYU","ã¡ã‚‡":"TYO",
            "ã«ã‚ƒ":"NYA","ã«ã‚…":"NYU","ã«ã‚‡":"NYO","ã²ã‚ƒ":"HYA","ã²ã‚…":"HYU","ã²ã‚‡":"HYO","ã¿ã‚ƒ":"MYA","ã¿ã‚…":"MYU","ã¿ã‚‡":"MYO",
            "ã‚Šã‚ƒ":"RYA","ã‚Šã‚…":"RYU","ã‚Šã‚‡":"RYO","ãã‚ƒ":"GYA","ãã‚…":"GYU","ãã‚‡":"GYO","ã˜ã‚ƒ":"ZYA","ã˜ã‚…":"ZYU","ã˜ã‚‡":"ZYO",
            "ã³ã‚ƒ":"BYA","ã³ã‚…":"BYU","ã³ã‚‡":"BYO","ã´ã‚ƒ":"PYA","ã´ã‚…":"PYU","ã´ã‚‡":"PYO",
            "ãµã":"FA","ãµãƒ":"FI","ãµã‡":"FE","ãµã‰":"FO","ã¦ãƒ":"TI","ã§ãƒ":"DI","ã†ãƒ":"WI","ã†ã‡":"WE","ã†ã‰":"WHO","ã¡ã‡":"TYE","ã—ã‡":"SYE","ã˜ã‡":"ZYE",
            "ã‚”":"VU","ãƒ¼":"-","ã":"XA","ãƒ":"XI","ã…":"XU","ã‡":"XE","ã‰":"XO","ã£":"XTU","ã‚ƒ":"XYA","ã‚…":"XYU","ã‚‡":"XYO"
        };

const wordList = [
            // --- å‹•ç‰© (Animals) ---
            {k:"ã‚‰ã„ãŠã‚“",e:"ğŸ¦"},{k:"ã¨ã‚‰",e:"ğŸ¯"},{k:"ã±ã‚“ã ",e:"ğŸ¼"},{k:"ã†ã•ã",e:"ğŸ°"},{k:"ã­ã“",e:"ğŸ±"},
            {k:"ã„ã¬",e:"ğŸ¶"},{k:"ãã‚Šã‚“",e:"ğŸ¦’"},{k:"ãã†",e:"ğŸ˜"},{k:"ã•ã‚‹",e:"ğŸµ"},{k:"ãã¾",e:"ğŸ»"},
            {k:"ã“ã‚ã‚‰",e:"ğŸ¨"},{k:"ã†ã¾",e:"ğŸ"},{k:"ã†ã—",e:"ğŸ„"},{k:"ã²ã¤ã˜",e:"ğŸ‘"},{k:"ã¶ãŸ",e:"ğŸ·"},
            {k:"ã„ã®ã—ã—",e:"ğŸ—"},{k:"ã­ãšã¿",e:"ğŸ­"},{k:"ã¯ã‚€ã™ãŸãƒ¼",e:"ğŸ¹"},{k:"ã‚Šã™",e:"ğŸ¿ï¸"},{k:"ã—ã‹",e:"ğŸ¦Œ"},
            {k:"ãã¤ã­",e:"ğŸ¦Š"},{k:"ãŸã¬ã",e:"ğŸ¦"},{k:"ãŠãŠã‹ã¿",e:"ğŸº"},{k:"ã”ã‚Šã‚‰",e:"ğŸ¦"},{k:"ã‹ã‚“ãŒã‚‹ãƒ¼",e:"ğŸ¦˜"},
            {k:"ã‚‰ãã ",e:"ğŸª"},{k:"ã‹ã°",e:"ğŸ¦›"},{k:"ã•ã„",e:"ğŸ¦"},{k:"ã—ã¾ã†ã¾",e:"ğŸ¦“"},{k:"ã¯ã‚Šã­ãšã¿",e:"ğŸ¦”"},

            // --- æµ·ã®ç”Ÿãç‰© (Sea Creatures) ---
            {k:"ãã˜ã‚‰",e:"ğŸ³"},{k:"ã„ã‚‹ã‹",e:"ğŸ¬"},{k:"ã•ã‹ãª",e:"ğŸŸ"},{k:"ãºã‚“ãã‚“",e:"ğŸ§"},{k:"ã‹ã‚",e:"ğŸ¢"},
            {k:"ã•ã‚",e:"ğŸ¦ˆ"},{k:"ãŸã“",e:"ğŸ™"},{k:"ã„ã‹",e:"ğŸ¦‘"},{k:"ãˆã³",e:"ğŸ¦"},{k:"ã‹ã«",e:"ğŸ¦€"},
            {k:"ãµã",e:"ğŸ¡"},{k:"ã‚ã–ã‚‰ã—",e:"ğŸ¦­"},{k:"ã‚‰ã£ã“",e:"ğŸ¦¦"},{k:"ãã‚‰ã’",e:"ğŸª¼"},{k:"ã²ã¨ã§",e:"â­"},

            // --- é³¥ãƒ»è™«ãƒ»ç”Ÿãç‰© (Birds & Bugs) ---
            {k:"ã«ã‚ã¨ã‚Š",e:"ğŸ”"},{k:"ã²ã‚ˆã“",e:"ğŸ¥"},{k:"ã‚ã²ã‚‹",e:"ğŸ¦†"},{k:"ãµãã‚ã†",e:"ğŸ¦‰"},{k:"ã‚ã—",e:"ğŸ¦…"},
            {k:"ã„ã‚“ã“",e:"ğŸ¦œ"},{k:"ã¯ãã¡ã‚‡ã†",e:"ğŸ¦¢"},{k:"ãµã‚‰ã¿ã‚“ã”",e:"ğŸ¦©"},{k:"ãã˜ã‚ƒã",e:"ğŸ¦š"},{k:"ã¯ã¨",e:"ğŸ•Šï¸"},
            {k:"ã¡ã‚‡ã†ã¡ã‚‡",e:"ğŸ¦‹"},{k:"ã¦ã‚“ã¨ã†ã‚€ã—",e:"ğŸ"},{k:"ã‚ã‚Š",e:"ğŸœ"},{k:"ã¯ã¡",e:"ğŸ"},{k:"ã‹ã¶ã¨ã‚€ã—",e:"ğŸª²"},
            {k:"ã‹ãŸã¤ã‚€ã‚Š",e:"ğŸŒ"},{k:"ãã‚‚",e:"ğŸ•·ï¸"},{k:"ã»ãŸã‚‹",e:"âœ¨"},{k:"ã‹ãˆã‚‹",e:"ğŸ¸"},{k:"ã¸ã³",e:"ğŸ"},

            // --- é£Ÿã¹ç‰©ãƒ»æœç‰© (Foods & Fruits) ---
            {k:"ã‚Šã‚“ã”",e:"ğŸ"},{k:"ã°ãªãª",e:"ğŸŒ"},{k:"ã™ã„ã‹",e:"ğŸ‰"},{k:"ã„ã¡ã”",e:"ğŸ“"},{k:"ã¿ã‹ã‚“",e:"ğŸŠ"},
            {k:"ã‚ã‚ã‚“",e:"ğŸˆ"},{k:"ã¶ã©ã†",e:"ğŸ‡"},{k:"ã‚‚ã‚‚",e:"ğŸ‘"},{k:"ã•ãã‚‰ã‚“ã¼",e:"ğŸ’"},{k:"ãªã—",e:"ğŸ"},
            {k:"ã±ã„ãªã£ã·ã‚‹",e:"ğŸ"},{k:"ãã†ã„",e:"ğŸ¥"},{k:"ã‚Œã‚‚ã‚“",e:"ğŸ‹"},{k:"ã‚ã¼ã‹ã©",e:"ğŸ¥‘"},{k:"ãã‚Š",e:"ğŸŒ°"},
            {k:"ã«ã‚“ã˜ã‚“",e:"ğŸ¥•"},{k:"ã¨ã¾ã¨",e:"ğŸ…"},{k:"ãªã™",e:"ğŸ†"},{k:"ãã‚…ã†ã‚Š",e:"ğŸ¥’"},{k:"ã¨ã†ã‚‚ã‚ã“ã—",e:"ğŸŒ½"},
            {k:"ã´ãƒ¼ã¾ã‚“",e:"ğŸ«‘"},{k:"ã˜ã‚ƒãŒã„ã‚‚",e:"ğŸ¥”"},{k:"ã•ã¤ã¾ã„ã‚‚",e:"ğŸ "},{k:"ãŸã¾ã­ã",e:"ğŸ§…"},{k:"ãã®ã“",e:"ğŸ„"},
            {k:"ã¶ã‚ã£ã“ã‚Šãƒ¼",e:"ğŸ¥¦"},{k:"ã‹ã¼ã¡ã‚ƒ",e:"ğŸƒ"},{k:"ã¾ã‚",e:"ğŸ«›"},{k:"ã”ã¯ã‚“",e:"ğŸš"},{k:"ã±ã‚“",e:"ğŸ"},
            {k:"ã‘ãƒ¼ã",e:"ğŸ°"},{k:"ã‚ã‚",e:"ğŸ¬"},{k:"ã‚ã„ã™ãã‚Šãƒ¼ã‚€",e:"ğŸ¨"},{k:"ã·ã‚Šã‚“",e:"ğŸ®"},{k:"ã¯ã‚“ã°ãƒ¼ã",e:"ğŸ–"},
            {k:"ã‹ã‚Œãƒ¼ã‚‰ã„ã™",e:"ğŸ›"},{k:"ãŠã™ã—",e:"ğŸ£"},{k:"ã‚‰ãƒ¼ã‚ã‚“",e:"ğŸœ"},{k:"ã•ã‚“ã©ã„ã£ã¡",e:"ğŸ¥ª"},{k:"ãŠã«ãã‚Š",e:"ğŸ™"},
            {k:"ã´ã–",e:"ğŸ•"},{k:"ã™ã±ã’ã£ã¦ãƒ",e:"ğŸ"},{k:"ã†ã©ã‚“",e:"ğŸœ"},{k:"ãã‚‡ã†ã–",e:"ğŸ¥Ÿ"},{k:"ã¹ã‚“ã¨ã†",e:"ğŸ±"},
            {k:"ã ã‚“ã”",e:"ğŸ¡"},{k:"ã©ãƒ¼ãªã¤",e:"ğŸ©"},{k:"ã¡ã‚‡ã“ã‚Œãƒ¼ã¨",e:"ğŸ«"},{k:"ãã£ããƒ¼",e:"ğŸª"},{k:"ã½ã¦ã¨",e:"ğŸŸ"},
            {k:"ã¯ã‚“ã°ãƒ¼ãŒãƒ¼",e:"ğŸ”"},{k:"ã»ã£ã¨ã©ã£ã",e:"ğŸŒ­"},{k:"ãŸã“ã‚„ã",e:"ğŸ™"},{k:"ãˆã³ãµã‚‰ã„",e:"ğŸ¤"},{k:"ã‚ã ã¾ã‚„ã",e:"ğŸ³"},

            // --- ä¹—ã‚Šç‰© (Vehicles) ---
            {k:"ãã‚‹ã¾",e:"ğŸš—"},{k:"ã§ã‚“ã—ã‚ƒ",e:"ğŸšƒ"},{k:"ã—ã‚“ã‹ã‚“ã›ã‚“",e:"ğŸš„"},{k:"ã²ã“ã†ã",e:"âœˆï¸"},{k:"ãµã­",e:"ğŸš¢"},
            {k:"ã°ã™",e:"ğŸšŒ"},{k:"ã˜ã¦ã‚“ã—ã‚ƒ",e:"ğŸš²"},{k:"ã‚ã‘ã£ã¨",e:"ğŸš€"},{k:"ã¸ã‚Šã“ã·ãŸãƒ¼",e:"ğŸš"},{k:"ã±ã¨ã‹ãƒ¼",e:"ğŸš“"},
            {k:"ãã‚…ã†ãã‚…ã†ã—ã‚ƒ",e:"ğŸš‘"},{k:"ã—ã‚‡ã†ã¼ã†ã—ã‚ƒ",e:"ğŸš’"},{k:"ã¨ã‚‰ã£ã",e:"ğŸšš"},{k:"ãŸãã—ãƒ¼",e:"ğŸš•"},{k:"ã‚‚ã®ã‚Œãƒ¼ã‚‹",e:"ğŸš"},
            {k:"ãã‹ã‚“ã—ã‚ƒ",e:"ğŸš‚"},{k:"ã‚ˆã£ã¨",e:"â›µ"},{k:"ã¼ãƒ¼ã¨",e:"ğŸš£"},{k:"ãŠãƒ¼ã¨ã°ã„",e:"ğŸï¸"},{k:"ã™ããƒ¼ãŸãƒ¼",e:"ğŸ›µ"},
            {k:"ã¨ã‚‰ããŸãƒ¼",e:"ğŸšœ"},{k:"ã ã‚“ã·ã‹ãƒ¼",e:"ğŸšš"},{k:"ã‘ãƒ¼ã¶ã‚‹ã‹ãƒ¼",e:"ğŸš "},{k:"ã¡ã‹ã¦ã¤",e:"ğŸš‡"},{k:"ããã‚…ã†",e:"ğŸˆ"},

            // --- å­¦æ ¡ãƒ»æ–‡æˆ¿å…· (School) ---
            {k:"ãŒã£ã“ã†",e:"ğŸ«"},{k:"ã›ã‚“ã›ã„",e:"ğŸ§‘â€ğŸ«"},{k:"ã¨ã‚‚ã ã¡",e:"ğŸ‘«"},{k:"ãˆã‚“ã´ã¤",e:"âœï¸"},{k:"ã®ãƒ¼ã¨",e:"ğŸ““"},
            {k:"ã¯ã•ã¿",e:"âœ‚ï¸"},{k:"ã„ã™",e:"ğŸª‘"},{k:"ã¤ããˆ",e:"ğŸª‘"},{k:"ã‹ã°ã‚“",e:"ğŸ’"},{k:"ã¨ã‘ã„",e:"âŒš"},
            {k:"ã‘ã—ã”ã‚€",e:"ğŸ§½"},{k:"ãŸã„ã„ã",e:"ğŸƒ"},{k:"ãŠã‚“ãŒã",e:"ğŸµ"},{k:"ã‚Šã‹",e:"ğŸ”¬"},{k:"ã•ã‚“ã™ã†",e:"ğŸ”¢"},
            {k:"ã“ãã”",e:"ğŸ“–"},{k:"ãšã“ã†",e:"ğŸ¨"},{k:"ãã‚…ã†ã—ã‚‡ã",e:"ğŸ¥›"},{k:"ã“ãã°ã‚“",e:"ğŸ‘¨â€ğŸ«"},{k:"ã¡ã‚‡ãƒ¼ã",e:"ğŸ–ï¸"},
            {k:"ã˜ã‚‡ã†ã",e:"ğŸ“"},{k:"ã»ã£ã¡ãã™",e:"ğŸ–‡ï¸"},{k:"ãµã§ã°ã“",e:"ğŸ‘"},{k:"ãã‚Œã‚ˆã‚“",e:"ğŸ–ï¸"},{k:"ã¨ã—ã‚‡ã—ã¤",e:"ğŸ“š"},

            // --- è‡ªç„¶ãƒ»å¤©æ°—ãƒ»å­£ç¯€ (Nature & Weather) ---
            {k:"ãŸã„ã‚ˆã†",e:"â˜€ï¸"},{k:"ã¤ã",e:"ğŸŒ™"},{k:"ã»ã—",e:"â­"},{k:"ã‚ã‚",e:"â˜”"},{k:"ã‚†ã",e:"â„ï¸"},
            {k:"ãã‚‚ã‚Š",e:"â˜ï¸"},{k:"ã‹ã¿ãªã‚Š",e:"âš¡"},{k:"ã‹ãœ",e:"ğŸƒ"},{k:"ã«ã˜",e:"ğŸŒˆ"},{k:"ã†ã¿",e:"ğŸŒŠ"},
            {k:"ã‚„ã¾",e:"â›°ï¸"},{k:"ã‹ã‚",e:"ğŸï¸"},{k:"ã¯ãª",e:"ğŸŒ»"},{k:"ã•ãã‚‰",e:"ğŸŒ¸"},{k:"ã¡ã‚…ãƒ¼ã‚Šã£ã·",e:"ğŸŒ·"},
            {k:"ã²ã¾ã‚ã‚Š",e:"ğŸŒ»"},{k:"ã°ã‚‰",e:"ğŸŒ¹"},{k:"ã‚ã•ãŒãŠ",e:"ğŸª´"},{k:"ã¯ã£ã±",e:"ğŸƒ"},{k:"ã",e:"ğŸŒ³"},
            {k:"ã•ã¼ã¦ã‚“",e:"ğŸŒµ"},{k:"ã‚„ã—ã®ã",e:"ğŸŒ´"},{k:"ã¡ãã‚…ã†",e:"ğŸŒ"},{k:"ã†ã¡ã‚…ã†",e:"ğŸŒŒ"},{k:"ã²",e:"ğŸ”¥"},
            {k:"ã¿ãš",e:"ğŸ’§"},{k:"ã“ãŠã‚Š",e:"ğŸ§Š"},{k:"ã‚ã",e:"ğŸ‚"},{k:"ãµã‚†",e:"â›„"},{k:"ã¯ã‚‹",e:"ğŸŒ¸"},

            // --- ä½“ãƒ»æœãƒ»èº«ã®å›ã‚Š (Body, Clothes & Daily) ---
            {k:"ã¦",e:"âœ‹"},{k:"ã‚ã—",e:"ğŸ¦¶"},{k:"ã‹ãŠ",e:"ğŸ˜€"},{k:"ã‚",e:"ğŸ‘ï¸"},{k:"ã¿ã¿",e:"ğŸ‘‚"},
            {k:"ãã¡",e:"ğŸ‘„"},{k:"ã¯ãª",e:"ğŸ‘ƒ"},{k:"ã‚†ã³",e:"ğŸ‘†"},{k:"ã¯",e:"ğŸ¦·"},{k:"ã‹ã¿",e:"ğŸ’‡"},
            {k:"ãµã",e:"ğŸ‘•"},{k:"ãã¤",e:"ğŸ‘Ÿ"},{k:"ã¼ã†ã—",e:"ğŸ§¢"},{k:"ã‚ãŒã­",e:"ğŸ‘“"},{k:"ãšã¼ã‚“",e:"ğŸ‘–"},
            {k:"ã™ã‹ãƒ¼ã¨",e:"ğŸ‘—"},{k:"ãã¤ã—ãŸ",e:"ğŸ§¦"},{k:"ã¦ã¶ãã‚",e:"ğŸ§¤"},{k:"ã¾ãµã‚‰ãƒ¼",e:"ğŸ§£"},{k:"ãã‚‚ã®",e:"ğŸ‘˜"},
            {k:"ã„ãˆ",e:"ğŸ "},{k:"ã‹ã•",e:"ğŸŒ‚"},{k:"ã‹ã",e:"ğŸ”‘"},{k:"ã•ã„ãµ",e:"ğŸ‘›"},{k:"ãŠã‹ã­",e:"ğŸ’°"},
            {k:"ã¦ã‚Œã³",e:"ğŸ“º"},{k:"ã™ã¾ã»",e:"ğŸ“±"},{k:"ã±ãã“ã‚“",e:"ğŸ’»"},{k:"ã‹ã‚ã‚‰",e:"ğŸ“·"},{k:"ã‚‰ã„ã¨",e:"ğŸ’¡"},
            {k:"ãŠãµã‚",e:"ğŸ›"},{k:"ã¨ã„ã‚Œ",e:"ğŸš½"},{k:"ã¹ã£ã©",e:"ğŸ›ï¸"},{k:"ã¯ã¶ã‚‰ã—",e:"ğŸª¥"},{k:"ã›ã£ã‘ã‚“",e:"ğŸ§¼"},
            {k:"ã”ã¿ã°ã“",e:"ğŸ—‘ï¸"},{k:"ã½ã™ã¨",e:"ğŸ“®"},{k:"ã©ã‚",e:"ğŸšª"},{k:"ã¾ã©",e:"ğŸªŸ"},{k:"ã‚Œã„ãã†ã“",e:"ğŸ§Š"},

            // --- ã‚¹ãƒãƒ¼ãƒ„ãƒ»éŠã³ãƒ»ä»•äº‹ãƒ»ãã®ä»– (Sports, Jobs & Others) ---
            {k:"ã’ãƒ¼ã‚€",e:"ğŸ®"},{k:"ã´ã‚ã®",e:"ğŸ¹"},{k:"ã¼ãƒ¼ã‚‹",e:"âš½"},{k:"ã‚„ãã‚…ã†",e:"âš¾"},{k:"ã•ã£ã‹ãƒ¼",e:"âš½"},
            {k:"ã°ã™ã‘",e:"ğŸ€"},{k:"ã¦ã«ã™",e:"ğŸ¾"},{k:"ã™ã„ãˆã„",e:"ğŸŠ"},{k:"ã™ããƒ¼",e:"â›·ï¸"},{k:"ã™ã‘ãƒ¼ã¨",e:"â›¸ï¸"},
            {k:"ã¤ã‚Š",e:"ğŸ£"},{k:"ãã‚ƒã‚“ã·",e:"â›º"},{k:"ãˆ",e:"ğŸ–¼ï¸"},{k:"ã†ãŸ",e:"ğŸ¤"},{k:"ããŸãƒ¼",e:"ğŸ¸"},
            {k:"ãŸã„ã“",e:"ğŸ¥"},{k:"ã¨ã‚‰ã‚“ã·",e:"ğŸƒ"},{k:"ã¤ã¿ã",e:"ğŸ§±"},{k:"ã‚ã¼ã£ã¨",e:"ğŸ¤–"},{k:"ãŠã°ã‘",e:"ğŸ‘»"},
            {k:"ã„ã—ã‚ƒ",e:"ğŸ‘¨â€âš•ï¸"},{k:"ã‹ã‚“ã”ã—",e:"ğŸ§‘â€âš•ï¸"},{k:"ã‘ã„ã•ã¤ã‹ã‚“",e:"ğŸ‘®"},{k:"ã—ã‚‡ã†ã¼ã†ã—",e:"ğŸ§‘â€ğŸš’"},{k:"ã“ã£ã",e:"ğŸ‘¨â€ğŸ³"},
            {k:"ã ã„ã",e:"ğŸ‘·"},{k:"ã‚ã‹",e:"ğŸ”´"},{k:"ã‚ãŠ",e:"ğŸ”µ"},{k:"ãã„ã‚",e:"ğŸŸ¡"},{k:"ã¿ã©ã‚Š",e:"ğŸŸ¢"},
            {k:"ã´ã‚“ã",e:"ğŸ©·"},{k:"ã‚€ã‚‰ã•ã",e:"ğŸŸ£"},{k:"ãã‚",e:"âš«"},{k:"ã—ã‚",e:"âšª"},{k:"ã¯ãƒ¼ã¨",e:"â¤ï¸"}
        ];

        let questions=[], curIdx=0, typedRoma="", targetRomaDisp="";
        let startTime, isPlaying=false, timerInterval;
        let pausedTime = 0; // ãƒãƒ¼ã‚ºæ™‚ã®çµŒéæ™‚é–“ä¿æŒç”¨
        let isPaused = false;
        let currentModeCount=20;
        let skipNextN=false; 
        let audioCtx=null;
        let seEnabled=true;
        let isMuted=false;
        let missCount=0;

        const kb = document.getElementById('keyboard');
        const rows = ["QWERTYUIOP-", "ASDFGHJKL", "ZXCVBNM"];
        rows.forEach(rowChars => {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'kb-row';
            rowChars.split("").forEach(k => {
                const div = document.createElement('div');
                div.className = 'key' + (k==='F'||k==='J' ? ' home' : '');
                div.id = `key-${k}`;
                div.innerText = k;
                rowDiv.appendChild(div);
            });
            kb.appendChild(rowDiv);
        });

        function init() {
            // è¨­å®šèª­ã¿è¾¼ã¿
            if(localStorage.getItem('typing_se_enabled') !== null) {
                seEnabled = (localStorage.getItem('typing_se_enabled') === 'true');
            } else {
                seEnabled = true; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆON
            }
            document.getElementById('se-toggle').checked = seEnabled;
            
            showRankings();
            updateDisplay(); // abc/ABCãƒ©ãƒ™ãƒ«ã®åˆæœŸåŒ–ã®ãŸã‚
        }

        // SEåˆ‡æ›¿
        document.getElementById('se-toggle').addEventListener('change', (e)=>{
            seEnabled = e.target.checked;
            localStorage.setItem('typing_se_enabled', seEnabled);
            if(seEnabled) playTone(800, 'square', 0.05);
        });

        function showHowto() { document.getElementById('modal-howto-overlay').style.display = 'flex'; }
        function showConcept() { document.getElementById('modal-concept-overlay').style.display = 'flex'; }
        function closeModalBtn() { document.querySelectorAll('.modal-overlay').forEach(e => e.style.display = 'none'); }
        function closeModal(e) { if (e.target.classList.contains('modal-overlay')) e.target.style.display = 'none'; }

        function playTone(freq, type, duration) {
            if(isMuted || !seEnabled) return;
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type; osc.frequency.value = freq;
                osc.connect(gain); gain.connect(audioCtx.destination);
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                osc.start(); osc.stop(audioCtx.currentTime + duration);
            } catch(e){}
        }
        function toggleMute() {
            isMuted = !isMuted;
            document.getElementById('mute-btn').innerText = isMuted ? "ğŸ”‡" : "ğŸ”Š";
            const c = document.getElementById('game-container');
            if(c.style.display !== 'none') c.focus();
        }

        function createDisplayRoma(kana) {
            let res = "";
            let i = 0;
            while(i < kana.length) {
                let s2 = kana.substring(i, i+2);
                let s1 = kana.substring(i, i+1);
                if(s1 === "ã£") {
                    let nextKana = kana.substring(i+1);
                    let nextRoma = createDisplayRoma(nextKana);
                    if(nextRoma.length > 0) res += nextRoma[0];
                    else res += "X"; 
                    i++;
                } else if(romaTable[s2]) {
                    res += romaTable[s2];
                    i += 2;
                } else if(romaTable[s1]) {
                    res += romaTable[s1];
                    i += 1;
                } else {
                    res += s1; i += 1;
                }
            }
            return res;
        }

        function startGame(count) {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if(audioCtx.state === 'suspended') audioCtx.resume();
            
            currentModeCount = count;
            isPlaying = true; curIdx = 0; 
            startTime = Date.now(); pausedTime = 0; isPaused = false;
            skipNextN = false; missCount = 0;
            
            // ç°¡æ˜“çš„ãªãƒ©ãƒ³ãƒ€ãƒ æŠ½å‡ºï¼ˆé‡è¤‡ãªã—ï¼‰
            let qPool = [...wordList];
            questions = [];
            for(let i=0; i<count; i++){
                if(qPool.length===0) qPool = [...wordList];
                const rnd = Math.floor(Math.random()*qPool.length);
                questions.push(qPool[rnd]);
                qPool.splice(rnd, 1);
            }

            document.getElementById('overlay').style.display = "none";
            document.getElementById('result-overlay').style.display = "none";
            document.getElementById('pause-overlay').style.display = "none";
            
            // è¦ªã‚³ãƒ³ãƒ†ãƒŠã¯å¸¸ã«è¡¨ç¤º
            const container = document.getElementById('game-container');
            container.focus();

            nextWord();
            startTimer();
        }

        function startTimer() {
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if(!isPaused) {
                    const elapsed = (Date.now() - startTime) / 1000;
                    document.getElementById('timer').innerText = `${elapsed.toFixed(1)}ã³ã‚‡ã†`;
                }
            }, 100);
        }

        function pauseGame() {
            if(!isPlaying || isPaused) return;
            isPaused = true;
            pausedTime = Date.now() - startTime;
            clearInterval(timerInterval);
            document.getElementById('pause-overlay').style.display = 'flex';
        }

        function resumeGame() {
            if(!isPlaying || !isPaused) return;
            isPaused = false;
            startTime = Date.now() - pausedTime;
            document.getElementById('pause-overlay').style.display = 'none';
            document.getElementById('game-container').focus();
            startTimer();
        }

        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚ŒãŸã‚‰ãƒãƒ¼ã‚º
        window.addEventListener('blur', () => {
            if(isPlaying && !isPaused) {
                pauseGame();
            }
        });

        function nextWord() {
            if (curIdx >= questions.length) return endGame();
            typedRoma = "";
            targetRomaDisp = createDisplayRoma(questions[curIdx].k);
            updateDisplay();
        }

        function updateDisplay() {
            const isUpper = document.getElementById('case-switch').checked;
            
            // ãƒ©ãƒ™ãƒ«ã®å¼·èª¿è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            if(isUpper) {
                document.getElementById('label-ABC').classList.add('active');
                document.getElementById('label-abc').classList.remove('active');
            } else {
                document.getElementById('label-abc').classList.add('active');
                document.getElementById('label-ABC').classList.remove('active');
            }

            document.querySelectorAll('.key').forEach(k => {
                const base = k.id.substring(4);
                k.innerText = isUpper ? base : base.toLowerCase();
            });

            if(!isPlaying) return;

            document.getElementById('target-emoji').innerText = questions[curIdx].e;
            document.getElementById('target-kana').innerText = questions[curIdx].k;
            document.getElementById('remain').innerText = questions.length - curIdx;

            let html = "";
            for(let i=0; i<targetRomaDisp.length; i++) {
                let char = isUpper ? targetRomaDisp[i] : targetRomaDisp[i].toLowerCase();
                if(i < typedRoma.length) html += `<span class="typed">${char}</span>`;
                else if(i === typedRoma.length) html += `<span class="next-char">${char}</span>`;
                else html += `<span>${char}</span>`;
            }
            document.getElementById('target-roma').innerHTML = html;

            document.querySelectorAll('.key').forEach(k => k.classList.remove('active'));
            const nextKey = targetRomaDisp[typedRoma.length];
            if(nextKey) {
                const keyEl = document.getElementById(`key-${nextKey.toUpperCase()}`);
                if(keyEl) keyEl.classList.add('active');
            }
        }

        function replaceTargetStr(startIdx, deleteCount, insertStr) {
             targetRomaDisp = targetRomaDisp.substring(0, startIdx) + insertStr + targetRomaDisp.substring(startIdx + deleteCount);
        }

        // æˆ»ã‚‹å‡¦ç†
        function backToMenu() {
            isPlaying = false;
            isPaused = false;
            clearInterval(timerInterval);
            
            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤åˆ¶å¾¡
            document.getElementById('result-overlay').style.display = 'none';
            document.getElementById('pause-overlay').style.display = 'none';
            document.getElementById('overlay').style.display = 'flex';
            
            showRankings();
            playTone(440, 'sine', 0.1);
        }

        window.addEventListener('keydown', (e) => {
            // Escã‚­ãƒ¼å¯¾å¿œ
            if (e.key === "Escape") {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚Œã°é–‰ã˜ã‚‹
                const modals = document.querySelectorAll('.modal-overlay');
                let subModalClosed = false;
                modals.forEach(m => {
                    if(m.style.display === 'flex' && m.id !== 'result-overlay' && m.id !== 'pause-overlay') {
                        m.style.display = 'none';
                        subModalClosed = true;
                    }
                });
                if(subModalClosed) return;

                // ã‚²ãƒ¼ãƒ ä¸­ã€ãƒãƒ¼ã‚ºä¸­ã€ãƒªã‚¶ãƒ«ãƒˆç”»é¢ãªã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸
                if(isPlaying || isPaused || document.getElementById('result-overlay').style.display === 'flex') {
                    backToMenu();
                }
                return;
            }

            if (!isPlaying || isPaused) {
                if(document.getElementById('overlay').style.display !== 'none' && e.code === "Space") {
                    e.preventDefault();
                    startGame(30); 
                }
                return;
            }
            
            // å…¥åŠ›ç„¡è¦–ã‚­ãƒ¼
            if (e.key === "Shift" || e.ctrlKey || e.altKey || e.metaKey || e.key === "Tab") return;

            // ã‚­ãƒ¼ã‚¿ãƒƒãƒéŸ³
            playTone(800, 'square', 0.03);

            let inputChar = e.key.toUpperCase();
            if (inputChar === '-') inputChar = '-'; // ãƒã‚¤ãƒ•ãƒ³å¯¾å¿œ
            
            if(inputChar.length !== 1) return;

            let loopCount = 0;
            while(loopCount < 2) {
                if (skipNextN) {
                    skipNextN = false;
                    if (inputChar === 'N') break; 
                }

                const currentIdx = typedRoma.length;
                if (currentIdx >= targetRomaDisp.length) break;

                let targetChar = targetRomaDisp[currentIdx];

                // æŸ”è»Ÿãªå…¥åŠ›ãƒ­ã‚¸ãƒƒã‚¯
                if (currentIdx > 0 && typedRoma[currentIdx - 1] === 'S' && targetChar === 'I' && inputChar === 'H') {
                    replaceTargetStr(currentIdx, 0, 'H'); targetChar = 'H';
                }
                if (targetChar === 'T' && inputChar === 'C' && targetRomaDisp[currentIdx+1] === 'I') {
                    replaceTargetStr(currentIdx, 2, 'CHI'); targetChar = 'C';
                }
                if (currentIdx > 0 && typedRoma[currentIdx - 1] === 'T' && targetChar === 'U' && inputChar === 'S') {
                    replaceTargetStr(currentIdx, 0, 'S'); targetChar = 'S';
                }
                if (targetChar === 'H' && inputChar === 'F' && targetRomaDisp[currentIdx+1] === 'U') {
                    replaceTargetStr(currentIdx, 2, 'FU'); targetChar = 'F';
                }
                if (targetChar === 'Z' && inputChar === 'J' && targetRomaDisp[currentIdx+1] === 'I') {
                    replaceTargetStr(currentIdx, 2, 'JI'); targetChar = 'J';
                }
                if (currentIdx > 0 && typedRoma[currentIdx - 1] === 'S' && targetChar === 'Y' && inputChar === 'H') {
                    replaceTargetStr(currentIdx, 1, 'H'); targetChar = 'H';
                }
                if (targetChar === 'T' && inputChar === 'C' && targetRomaDisp.substr(currentIdx, 2) === 'TY') {
                    replaceTargetStr(currentIdx, 2, 'CH'); targetChar = 'C';
                }
                if (targetChar === 'Z' && inputChar === 'J' && targetRomaDisp.substr(currentIdx, 2) === 'ZY') {
                     replaceTargetStr(currentIdx, 3, 'JA'); targetChar = 'J';
                }
                
                let autoSkip = false;
                if (currentIdx > 0 && typedRoma[currentIdx - 1] === 'N' && targetChar === 'N') {
                    let nextChar = targetRomaDisp[currentIdx + 1];
                    if (inputChar !== 'N' && inputChar === nextChar) {
                        const vowels = ['A','I','U','E','O','N','Y'];
                        if (!vowels.includes(nextChar)) {
                            typedRoma += 'N'; 
                            loopCount++; 
                            autoSkip = true;
                        }
                    }
                }

                if (autoSkip) continue;

                if (inputChar === targetChar) {
                    typedRoma += targetChar;
                    playTone(880, 'sine', 0.05);
                    checkWordClear();
                } else {
                    missCount++;
                    playTone(150, 'sawtooth', 0.2);
                    
                    const container = document.getElementById('game-container');
                    container.classList.remove('miss-effect');
                    void container.offsetWidth;
                    container.classList.add('miss-effect');
                    
                    setTimeout(()=>{ container.classList.remove('miss-effect'); }, 300);
                }
                break;
            }
        });

        function checkWordClear() {
            let isEndN = false;
            if (typedRoma.length === targetRomaDisp.length - 1) {
                if (targetRomaDisp.endsWith("NN") && typedRoma.endsWith("N")) {
                    isEndN = true;
                }
            }

            if (typedRoma.length >= targetRomaDisp.length || isEndN) {
                if (isEndN) skipNextN = true;
                curIdx++;
                playTone(523, 'sine', 0.1);
                nextWord();
            } else {
                updateDisplay();
            }
        }

        function saveRecord(time) {
            if (currentModeCount !== 30) return null;
            let scores = JSON.parse(localStorage.getItem(`typing_rank_master30_kids`)) || [];
            const timestamp = Date.now();
            scores.push({ time: time, date: timestamp });
            scores.sort((a, b) => a.time - b.time);
            scores = scores.slice(0, 50);
            localStorage.setItem(`typing_rank_master30_kids`, JSON.stringify(scores));
            return { scores, timestamp };
        }

        function showRankings() {
            const data = JSON.parse(localStorage.getItem(`typing_rank_master30_kids`)) || [];
            const html = data.length ? data.slice(0,5).map((s, i) => 
                `<div class="rank-row">
                    <span>${i===0?'ğŸ¥‡':(i===1?'ğŸ¥ˆ':(i===2?'ğŸ¥‰':(i+1)+'ä½'))}</span> 
                    <span>${s.time.toFixed(1)}ã³ã‚‡ã†</span>
                </div>`
            ).join('') : "<div style='text-align:center; padding:10px;'>ãã‚ã ãªã—</div>";
            document.getElementById('rank-list').innerHTML = html;
        }
        
        function resetRankings() {
            if(confirm("ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã® ãã‚ãã‚’\nãƒªã‚»ãƒƒãƒˆï¼ˆã•ãã˜ã‚‡ï¼‰ã—ã¦ã‚‚ ã„ã„ã§ã™ã‹ï¼Ÿ")) {
                localStorage.removeItem(`typing_rank_master30_kids`);
                showRankings();
                alert("ãã‚ãã‚’ ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
            }
        }

        function endGame() {
            clearInterval(timerInterval); isPlaying = false;
            const finalTime = (Date.now() - startTime) / 1000;
            const resultData = saveRecord(finalTime);
            
            document.getElementById('result-overlay').style.display = "flex";
            const titleEl = document.getElementById('res-title');
            const msgEl = document.getElementById('res-msg');
            
            if(missCount === 0) {
                titleEl.innerHTML = "ğŸ‰ PERFECT! ğŸ‰";
                titleEl.style.color = "#e91e63";
                msgEl.innerHTML = `ã‚¿ã‚¤ãƒ : ${finalTime.toFixed(1)}ã³ã‚‡ã†<br><span style="color:#e91e63; font-size:1.5rem;">ğŸ’¯ ãƒ•ãƒ«ã‚³ãƒ³ãƒœï¼ï¼</span>`;
                playTone(1000, 'sine', 0.1); setTimeout(()=>playTone(1500, 'sine', 0.3), 200);
            } else {
                titleEl.innerHTML = "FINISH!";
                titleEl.style.color = "var(--master-gold)";
                msgEl.innerHTML = `ã‚¿ã‚¤ãƒ : ${finalTime.toFixed(1)}ã³ã‚‡ã†`;
                playTone(600, 'sine', 0.1); setTimeout(()=>playTone(800, 'sine', 0.3), 200);
            }

            if(currentModeCount === 10) {
                msgEl.innerHTML += "<br><span style='font-size:0.8rem; color:#777'>(ã‚Œã‚“ã—ã‚…ã†ãƒ¢ãƒ¼ãƒ‰)</span>";
                document.getElementById('res-ranking-list').innerHTML = "<div style='text-align:center;'>ã‚Œã‚“ã—ã‚…ã†ãƒ¢ãƒ¼ãƒ‰ã¯<br>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã« ã®ã‚‰ãªã„ã‚ˆ</div>";
            } else if(resultData) {
                let myRankIdx = -1;
                const scores = resultData.scores;
                scores.forEach((s, i) => { if(s.date === resultData.timestamp) myRankIdx = i; });

                let html = "";
                scores.forEach((s, i) => {
                    if (i < 5 || i === myRankIdx) {
                        if (i === myRankIdx && i > 5) html += `<div style="text-align:center; color:#ccc;">ãƒ» ãƒ» ãƒ»</div>`;
                        const isMine = (i === myRankIdx);
                        const rankClass = isMine ? "rank-row my-rank" : "rank-row";
                        const rankIcon = i===0?'ğŸ¥‡':(i===1?'ğŸ¥ˆ':(i===2?'ğŸ¥‰':(i+1)+'ä½'));
                        html += `<div class="${rankClass}">
                            <span>${rankIcon}</span> 
                            <span>${s.time.toFixed(1)}ã³ã‚‡ã†</span>
                        </div>`;
                    }
                });
                document.getElementById('res-ranking-list').innerHTML = html;
            }
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else if (document.exitFullscreen) document.exitFullscreen();
        }
    </script>
</body>
</html>