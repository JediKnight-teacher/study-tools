<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒ­ãƒ¼ãƒå­—ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆ1ã‚‚ã˜ã¨ã£ãã‚“ï¼‰</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #ec407a;
            --accent-color: #ffca28;
            --bg-color: #fce4ec;
            --key-bg: #fff;
            --key-shadow: #cfd8dc;
            --text-color: #444;
            --text-dark: #37474f;
            --timer-color: #3e2723;
        }
        body { 
            font-family: 'Zen Maru Gothic', 'Hiragino Maru Gothic ProN', 'Rounded Mplus 1c', 'Meiryo', sans-serif; 
            text-align: center; background-color: var(--bg-color); margin: 0; padding: 0;
            color: var(--text-color); overflow: hidden; user-select: none;
            height: 100vh; display: flex; justify-content: center; align-items: center;
        }
        body.order-mode { --primary-color: #0ea5e9; --bg-color: #e0f2fe; }
        
        #game-wrapper {
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
        }

        #game-container { 
            background: white; 
            width: 96%; max-width: 1100px;
            /* WXGAç­‰ã®ç¸¦ãŒçŸ­ã„ç”»é¢ã«å¯¾å¿œã™ã‚‹ãŸã‚ã€é«˜ã•ã®åˆ¶é™ã‚’ç·©å’Œ */
            height: 96vh; max-height: 720px;
            padding: 15px; 
            border: 8px solid #f8bbd0; border-radius: 20px; box-shadow: 0 10px 0 rgba(0,0,0,0.1);
            position: relative; box-sizing: border-box;
            display: flex; flex-direction: column; justify-content: space-between; align-items: center;
            transform: translate3d(0, 0, 0);
        }
        body.order-mode #game-container { border-color: #bae6fd; }

        /* --- ã‚²ãƒ¼ãƒ ç”»é¢ï¼ˆãƒ—ãƒ¬ã‚¤ä¸­ï¼‰ --- */
        .info-bar { 
            display: flex; justify-content: center; 
            width: 100%; font-size: 1.4rem; font-weight: bold; color: #555; 
            margin-bottom: 5px; height: 40px; align-items: center;
            position: relative;
        }
        
        .remain-box { position: absolute; left: 10px; font-size: 1.2rem; }
        .timer-box { color: var(--timer-color); font-size: 1.8rem; z-index: 5; }

        /* ã‚¢ã‚¤ã‚³ãƒ³ç¾¤ï¼ˆå³ä¸Šï¼‰ */
        .top-icons {
            position: absolute; top: 5px; right: 10px; 
            display: flex; gap: 8px; z-index: 20;
        }
        .icon-btn {
            font-size: 1.3rem; cursor: pointer;
            background: rgba(255,255,255,0.9);
            border: 2px solid #eee;
            border-radius: 50%; width: 38px; height: 38px;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: 0.2s; user-select: none; color: #555;
        }
        .icon-btn:hover { transform: scale(1.1); background: #fff; }
        .icon-btn:active { transform: scale(0.95); }
        
        #display-area {
            flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;
            width: 100%; background: #fff5f8; border-radius: 16px; margin-bottom: 10px;
            border: 4px dashed #f48fb1;
            min-height: 150px;
        }
        body.order-mode #display-area { background: #f0f9ff; border-color: #81d4fa; }

        #target-kana { font-size: 8rem; font-weight: bold; line-height: 1; margin: -10px 0 10px; color: #333; }
        #target-roma { 
            font-size: 5rem; font-weight: bold; letter-spacing: 6px; 
            color: #b0bec5; font-family: 'Courier New', monospace; 
            min-height: 80px; line-height: 1;
        }
        .typed { color: var(--primary-color); }
        .next-char { color: #0288d1; text-decoration: underline; background-color: rgba(2, 136, 209, 0.1); border-radius: 5px; }

        #keyboard { 
            display: flex; flex-direction: column; gap: 8px; 
            width: 100%; padding: 15px 10px; 
            background: #eceff1; border-radius: 16px; 
            box-sizing: border-box; flex-shrink: 0;
        }
        .kb-row { display: flex; justify-content: center; gap: 8px; width: 100%; }
        
        .key { 
            width: 8%; max-width: 60px; aspect-ratio: 1/1;
            display: flex; justify-content: center; align-items: center;
            background: var(--key-bg); border-radius: 8px; 
            font-weight: bold; font-size: 1.4rem; 
            color: var(--text-dark); 
            box-shadow: 0 4px 0 var(--key-shadow);
            position: relative; transition: all 0.1s;
        }
        .key.active { 
            background: #ffeb3b !important; color: #212121; 
            box-shadow: 0 2px 0 #f9a825; transform: translateY(4px); 
        }
        .key.home { border: 2px solid #ff4081; }
        
        /* --- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ --- */
        #overlay { 
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.98); border-radius: 12px; z-index: 10; 
            display: flex; flex-direction: column; align-items: center;
            padding: 10px; overflow-y: auto;
        }

        /* ã‚¿ã‚¤ãƒˆãƒ«ã‚¨ãƒªã‚¢èª¿æ•´ï¼šã‚¢ã‚¤ã‚³ãƒ³ã¨è¢«ã‚‰ãªã„ã‚ˆã†ãƒãƒ¼ã‚¸ãƒ³ç¢ºä¿ã—ã¤ã¤ã€å…¨ä½“ã‚’å°‘ã—å°ã•ã */
        #title-area { 
            margin: 35px 0 5px; /* ä¸Šãƒãƒ¼ã‚¸ãƒ³ã‚’èª¿æ•´ */
            text-align: center; flex-shrink: 0;
        }
        #title-text { 
            margin: 0; font-size: 2.0rem; color: #333; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºå¾®èª¿æ•´ */
            text-shadow: 2px 2px 0 #eee; line-height: 1.2;
        }
        .subtitle { font-size: 1.1rem; color: #ec407a; font-weight: bold; margin-left: 8px; white-space: nowrap; }

        .btn-howto {
            background: #81d4fa; color: #01579b; border: none;
            padding: 6px 18px; border-radius: 20px; font-weight: bold;
            cursor: pointer; margin-top: 5px; font-family: inherit; font-size: 0.9rem;
            box-shadow: 0 3px 0 #4fc3f7; transition: 0.2s;
        }
        .btn-howto:hover { transform: translateY(-2px); filter: brightness(1.05); }
        .btn-howto:active { transform: translateY(2px); box-shadow: 0 1px 0 #4fc3f7; }

        .menu-wrapper {
            display: flex; width: 100%; max-width: 850px; gap: 15px;
            justify-content: center; align-items: stretch; flex-grow: 1;
            min-height: 0; 
            margin-top: 8px; margin-bottom: 5px;
        }

        /* è¨­å®šãƒ‘ãƒãƒ«ï¼šç¸¦å¹…ã‚’æŠ‘ãˆã‚‹èª¿æ•´ */
        .settings-panel {
            flex: 1; background: #fff; 
            border: 3px solid #eee; border-radius: 16px;
            padding: 10px 15px; display: flex; flex-direction: column; 
            justify-content: space-evenly; /* å‡ç­‰é…ç½®ã ãŒé–“éš”ã‚’è©°ã‚ã‚‹ */
            gap: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .panel-label { 
            font-size: 1.0rem; font-weight: bold; color: #555; 
            border-left: 5px solid var(--primary-color); padding-left: 8px; margin-bottom: 4px;
            display: flex; align-items: center;
        }

        /* ãƒ¬ãƒ™ãƒ«é¸æŠãƒœã‚¿ãƒ³ï¼šã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ– */
        .level-selector { display: flex; gap: 5px; }
        .lvl-btn {
            flex: 1; border: 2px solid #ddd; border-radius: 10px; padding: 4px 2px;
            cursor: pointer; background: #fff; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #777;
        }
        .lvl-btn:hover { background: #fdfdfd; transform: translateY(-2px); }
        .lvl-btn.selected { 
            border-color: var(--primary-color); background: #fff5f8; 
            color: var(--primary-color); font-weight: bold;
            box-shadow: 0 3px 0 #f8bbd0; transform: translateY(-2px);
        }
        .lvl-btn#lvl-btn-0.selected {
            border-color: #66bb6a; background: #e8f5e9; color: #2e7d32; box-shadow: 0 3px 0 #a5d6a7;
        }
        .lvl-icon { font-size: 1.3rem; margin-bottom: 0px; }
        .lvl-name { font-size: 0.75rem; line-height: 1.1; }
        
        /* ã‚¹ã‚¤ãƒƒãƒé¡ï¼šãƒ‘ãƒ‡ã‚£ãƒ³ã‚°èª¿æ•´ */
        .case-selector {
            display: flex; gap: 10px; align-items: center; background: #f5f5f5;
            padding: 6px; border-radius: 10px; justify-content: center;
        }
        .switch-label { font-weight: bold; font-size: 1.0rem; cursor: pointer; color: #aaa; transition: 0.2s;}
        .switch-label.active { color: #333; transform: scale(1.05); }
        
        .toggle-switch {
            position: relative; width: 50px; height: 26px; background: #ddd;
            border-radius: 30px; cursor: pointer; transition: 0.3s;
        }
        .toggle-switch::after {
            content: ''; position: absolute; top: 3px; left: 3px;
            width: 20px; height: 20px; background: white; border-radius: 50%;
            transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .toggle-switch.on { background: var(--primary-color); }
        .toggle-switch.on::after { left: 27px; }

        .reset-btn {
            background: transparent; border: none; border-left: 2px solid #ddd;
            padding-left: 10px; margin-left: 5px;
            cursor: pointer; font-size: 1.2rem; color: #ef5350;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        
        /* éŸ³è¨­å®šãƒ‘ãƒãƒ« */
        .sound-panel {
            background: #f5f5f5; padding: 6px 12px; border-radius: 10px; 
            display:flex; align-items:center;
        }

        /* ç›®æ¨™ã‚¿ã‚¤ãƒ é¸æŠï¼šé«˜ã•ã‚’æŠ‘ãˆã‚‹ */
        #target-time-select {
            font-size: 1.0rem; padding: 6px; width: 100%; border-radius: 8px; border: 2px solid #ddd;
        }

        .modes-panel {
            flex: 1; display: flex; flex-direction: column; gap: 12px;
        }

        .mode-card {
            flex: 1; border-radius: 16px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; 
            gap: 10px; 
            transition: 0.2s; position: relative; overflow: hidden;
            box-shadow: 0 5px 0 rgba(0,0,0,0.1); color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            border: none; width: 100%; padding: 0;
        }
        .mode-card:hover { transform: translateY(-3px); box-shadow: 0 8px 0 rgba(0,0,0,0.1); filter: brightness(1.05); }
        .mode-card:active { transform: translateY(3px); box-shadow: 0 2px 0 rgba(0,0,0,0.1); }

        .mode-card.random { background: linear-gradient(135deg, #ec407a, #d81b60); }
        .mode-card.order  { background: linear-gradient(135deg, #42a5f5, #1e88e5); }

        .mode-icon { font-size: 3.0rem; background: rgba(255,255,255,0.2); border-radius: 50%; width: 70px; height: 70px; display: flex; justify-content: center; align-items: center; }
        .mode-text { text-align: left; }
        
        .mode-title { font-size: 1.4rem; font-weight: bold; display: block; white-space: nowrap; }
        .mode-desc { font-size: 0.85rem; opacity: 0.9; margin-top: 4px; display: block; }

        #footer-area { width: 100%; max-width: 850px; display: flex; justify-content: space-between; align-items: end; margin-top: 8px; flex-shrink: 0;}
        .mini-rank { background: #fff; border: 2px solid #ddd; border-radius: 10px; padding: 6px 12px; font-size: 0.85rem; color: #666; width: 48%; }
        .mini-rank strong { color: var(--primary-color); }

        .stamp { font-size: 3rem; color: #e91e63; border: 5px solid #e91e63; padding: 10px 30px; border-radius: 20px; transform: rotate(-5deg); margin: 20px 0; display: inline-block; animation: pop 0.4s; background: rgba(255,255,255,0.9); }
        @keyframes pop { 0%{transform: scale(0);} 80%{transform: scale(1.1);} 100%{transform: scale(1) rotate(-5deg);} }

        .shake { animation: shake 0.2s; }
        @keyframes shake { 0%,100% {transform:translateX(0)} 25% {transform:translateX(8px)} 75% {transform:translateX(-8px)} }

        #result-content { display: none; flex-direction: column; align-items: center; width: 100%; height: 100%; justify-content: center; }
        .btn-retry { font-size: 1.5rem; padding: 15px 40px; color: white; background: #757575; border:none; border-radius: 50px; box-shadow: 0 6px #424242; cursor:pointer; font-weight:bold; margin-top: 30px; transition: 0.2s; }
        .btn-retry:hover { background: #888; transform: translateY(-2px); }
        .btn-retry:active { transform: translateY(4px); box-shadow: 0 2px #424242; }

        .copyright-link {
            margin-top: 8px; font-size: 0.75rem; color: #aaa; cursor: pointer; text-decoration: underline;
        }
        .copyright-link:hover { color: #ec407a; }

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« (éŠã³æ–¹ãƒ»ã‚³ãƒ³ã‚»ãƒ—ãƒˆ) --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 100;
            justify-content: center; align-items: center;
        }
        .modal-box {
            background: #fff; width: 90%; max-width: 650px; max-height: 85vh;
            border-radius: 20px; border: 6px solid #81d4fa;
            padding: 25px; overflow-y: auto; text-align: left;
            position: relative; animation: pop 0.2s ease-out;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .modal-box.concept-mode { border-color: #ec407a; }

        .modal-close {
            position: absolute; top: 10px; right: 15px; font-size: 2rem;
            color: #ccc; cursor: pointer; line-height: 1; font-weight: bold;
        }
        .modal-close:hover { color: #ec407a; }

        .howto-h2 { 
            text-align: center; color: #fff; background: #0277bd; border-radius: 30px;
            padding: 10px 20px; margin: 0 auto 20px auto; width: fit-content;
            box-shadow: 0 4px 0 #01579b; font-size: 1.5rem; border-bottom: none;
        }
        .concept-h2 { text-align: center; color: #c2185b; border-bottom: 3px dashed #f8bbd0; padding-bottom: 10px; margin-top: 0; }

        .howto-section { background: #e1f5fe; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 0 rgba(0,0,0,0.05); }
        .howto-section h3 { 
            margin: 0 0 15px 0; color: #0277bd; font-size: 1.3rem; 
            display: flex; align-items: center; gap: 8px;
            border-bottom: 2px solid rgba(2, 119, 189, 0.2); padding-bottom: 8px;
        }

        .howto-item { display: flex; align-items: flex-start; gap: 15px; margin-bottom: 15px; line-height: 1.6; }
        .howto-item:last-child { margin-bottom: 0; }
        .howto-icon { 
            font-size: 1.8rem; width: 50px; text-align: center; flex-shrink: 0; 
            background: #fff; border-radius: 50%; height: 50px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .howto-text { flex-grow: 1; font-size: 0.95rem; color: #444; }
        .badge-param {
            display: inline-block; background: #0288d1; color: #fff;
            padding: 3px 10px; border-radius: 15px; font-weight: bold;
            font-size: 0.9rem; margin-bottom: 5px; box-shadow: 0 2px 0 #01579b;
        }
        .level-detail {
            display: block; margin-top: 5px; background: rgba(255,255,255,0.6);
            padding: 10px; border-radius: 8px; font-size: 0.9rem; color: #555; line-height: 1.8;
        }
        .concept-list { font-size: 0.95rem; line-height: 1.6; color: #444; }
        .concept-list li { margin-bottom: 8px; }
        .license-box { background: #fce4ec; padding: 15px; border-radius: 10px; text-align: center; margin-top: 20px; font-weight: bold; color: #c2185b; border: 2px dashed #f48fb1; }

    </style>
</head>
<body>

    <div id="game-wrapper">
        <div id="game-container">
            <div id="modal-howto-overlay" class="modal-overlay" onclick="closeModal(event)">
                <div class="modal-box">
                    <span class="modal-close" onclick="closeModalBtn()">Ã—</span>
                    <h2 class="howto-h2">ğŸ“– ã‚ãã³ã‹ãŸãƒ»ã›ã¤ã‚ã„</h2>
                    
                    <div class="howto-section">
                        <h3>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã® ã›ã£ã¦ã„</h3>
                        <div class="howto-item">
                            <span class="howto-icon">â­</span>
                            <div class="howto-text">
                                <span class="badge-param">ã‚€ãšã‹ã—ã• (Lv)</span><br>
                                ã‚Œã‚“ã—ã‚…ã†ã™ã‚‹ ã‚‚ã˜ã‚’ ãˆã‚‰ã¹ã‚‹ã‚ˆã€‚
                                <span class="level-detail">
                                    ãƒ»Lv0ï¼š<strong>ã‚ã„ã†ãˆãŠ</strong> ã ã‘<br>
                                    ãƒ»Lv1ï¼š<strong>ã‚ï½ã‚“</strong> (ãã»ã‚“)<br>
                                    ãƒ»Lv2ï¼šLv1 ï¼‹ <strong>ã ããŠã‚“</strong> ( ãŒ ï½ ã½ )<br>
                                    ãƒ»Lv3ï¼šLv2 ï¼‹ <strong>ã‚ˆã†ãŠã‚“</strong> (ãã‚ƒï½ã‚Šã‚‡)
                                </span>
                            </div>
                        </div>
                        <div class="howto-item">
                            <span class="howto-icon">ğŸ…°ï¸</span>
                            <div class="howto-text">
                                <span class="badge-param">ã²ã‚‡ã†ã˜</span><br>
                                ã€Œabc (ã“ã‚‚ã˜)ã€ã¨ã€ŒABC (ãŠãŠã‚‚ã˜)ã€ã‚’ ã‹ãˆã‚‰ã‚Œã‚‹ã‚ˆã€‚
                            </div>
                        </div>
                        <div class="howto-item">
                            <span class="howto-icon">â°</span>
                            <div class="howto-text">
                                <span class="badge-param">ã‚‚ãã²ã‚‡ã† ã‚¿ã‚¤ãƒ </span><br>
                                ãªã‚“ã³ã‚‡ã†ã§ ã‚¯ãƒªã‚¢ã§ãã‚‹ã‹ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼<br>
                                ã€Œãªã—ã€ãªã‚‰ ã‚Œã‚“ã—ã‚…ã† ãƒ¢ãƒ¼ãƒ‰ã ã‚ˆã€‚
                            </div>
                        </div>
                        <div class="howto-item">
                            <span class="howto-icon">ğŸ—‘ï¸</span>
                            <div class="howto-text">
                                <span class="badge-param">ãã‚ãã‚’ ã‘ã™</span><br>
                                ã€Œã”ã¿ã°ã“ã€ãƒœã‚¿ãƒ³ã‚’ ãŠã™ã¨ã€ã™ã¹ã¦ã® ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒ ããˆã‚‹ã‚ˆã€‚
                            </div>
                        </div>
                    </div>

                    <div class="howto-section" style="background:#fff3e0;">
                        <h3 style="color:#ef6c00;">ã‚²ãƒ¼ãƒ ã® ãƒ¢ãƒ¼ãƒ‰</h3>
                        <div class="howto-item">
                            <span class="howto-icon">ğŸ²</span>
                            <div class="howto-text">
                                <span class="badge-param" style="background:#ef6c00; box-shadow:0 2px 0 #e65100;">ãƒãƒ©ãƒãƒ©</span><br>
                                ã‚‚ã‚“ã ã„ãŒ ãƒ©ãƒ³ãƒ€ãƒ (ãƒãƒ©ãƒãƒ©)ã« ã§ã‚‹ã‚ˆã€‚<br>
                                ãŠã‚ã£ãŸã‚‰ã€ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ ãªã‚“ã©ã‚‚ ã‚ãã¹ã‚‹ã‚ˆã€‚
                            </div>
                        </div>
                        <div class="howto-item">
                            <span class="howto-icon">ğŸ“</span>
                            <div class="howto-text">
                                <span class="badge-param" style="background:#ef6c00; box-shadow:0 2px 0 #e65100;">ã‚ã„ã†ãˆãŠ ã˜ã‚…ã‚“</span><br>
                                ã€Œã‚ã„ã†ãˆãŠâ€¦ã€ã® ã˜ã‚…ã‚“ã°ã‚“ã§ ãœã‚“ã¶ ã†ã¤ã‚ˆã€‚<br>
                                ã‚­ãƒ¼ã® ã°ã—ã‚‡ã‚’ ãŠã¼ãˆã‚‹ã®ã« ãƒ”ãƒƒã‚¿ãƒªï¼
                            </div>
                        </div>
                    </div>

                    <div class="howto-section" style="background:#e8f5e9;">
                        <h3 style="color:#2e7d32;">ãƒ—ãƒ¬ã‚¤ãŒã‚ã‚“ã® ã¿ã‹ãŸãƒ»ãã®ã†</h3>
                        <div class="howto-item">
                            <span class="howto-icon">âŒ¨ï¸</span>
                            <div class="howto-text">
                                <span class="badge-param" style="background:#43a047; box-shadow:0 2px 0 #2e7d32;">ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰</span><br>
                                ã¤ãã« ãŠã™ ã‚­ãƒ¼ãŒ ã²ã‹ã£ã¦ ãŠã—ãˆã¦ ãã‚Œã‚‹ã‚ˆã€‚
                            </div>
                        </div>
                        <div class="howto-item">
                            <span class="howto-icon">ğŸ‘€</span>
                            <div class="howto-text">
                                <span class="badge-param" style="background:#43a047; box-shadow:0 2px 0 #2e7d32;">ãƒ­ãƒ¼ãƒã˜</span><br>
                                ã¾ã‚“ãªã‹ã® ãŠãŠããª ã‚‚ã˜ã‚’ ã¿ã¦ ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã—ã‚ˆã†ï¼
                            </div>
                        </div>
                        <div class="howto-item">
                            <span class="howto-icon">ğŸ”Š</span>
                            <div class="howto-text">
                                <span class="badge-param" style="background:#43a047; box-shadow:0 2px 0 #2e7d32;">ãŠã¨ (ON/OFF)</span><br>
                                å³ä¸Šã® ãƒœã‚¿ãƒ³ã§ ãŠã¨ã‚’ ã‘ã—ãŸã‚Š ã¤ã‘ãŸã‚Š ã§ãã‚‹ã‚ˆã€‚
                            </div>
                        </div>
                        <div class="howto-item">
                            <span class="howto-icon">â›¶</span>
                            <div class="howto-text">
                                <span class="badge-param" style="background:#43a047; box-shadow:0 2px 0 #2e7d32;">å…¨ç”»é¢ (ãœã‚“ãŒã‚ã‚“)</span><br>
                                ãŒã‚ã‚“ ã„ã£ã±ã„ã« ãŠãŠãã ã§ãã‚‹ã‚ˆã€‚
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="modal-concept-overlay" class="modal-overlay" onclick="closeModal(event)">
                <div class="modal-box concept-mode">
                    <span class="modal-close" onclick="closeModalBtn()">Ã—</span>
                    <h2 class="concept-h2">ğŸ’¡ ã“ã®ãƒ„ãƒ¼ãƒ«ã«ã¤ã„ã¦</h2>
                    
                    <ul class="concept-list">
                        <li><strong>ğŸ« æ¥½ã—ãç¿’å¾—</strong><br>å°å­¦æ ¡ä½å­¦å¹´ã‹ã‚‰ã€éŠã³æ„Ÿè¦šã§ãƒ­ãƒ¼ãƒå­—å…¥åŠ›ã‚’è¦šãˆã‚‰ã‚Œã¾ã™ã€‚ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ã‚„ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºãªã©ã®ã‚²ãƒ¼ãƒ è¦ç´ ã‚’å–ã‚Šå…¥ã‚Œã€æ¥½ã—ãç¶™ç¶šã§ãã‚‹ã‚ˆã†ã«è¨­è¨ˆã—ã¾ã—ãŸã€‚</li>
                        <li><strong>ğŸ’» å­¦æ ¡ã®ç«¯æœ«ã«å¯¾å¿œ</strong><br>GIGAã‚¹ã‚¯ãƒ¼ãƒ«æ§‹æƒ³ã®ç«¯æœ«ï¼ˆWindows / Chromebookï¼‰ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œã—ã¾ã™ã€‚</li>
                        <li><strong>ğŸ›œ ãƒãƒƒãƒˆä¸è¦</strong><br>ã“ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚Œã°ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆãŒãªã„ç’°å¢ƒã§ã‚‚å®¶åº­ã‚„å­¦æ ¡ã§éŠã¹ã¾ã™ã€‚</li>
                        <li><strong>ğŸ¦„ ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ‰çµµæ–‡å­—ã¨ã‚·ãƒ³ãƒ—ãƒ«ãƒ»äº’æ›æ€§</strong><br>ã‚¤ãƒ©ã‚¹ãƒˆã‚„ã‚¢ã‚¤ã‚³ãƒ³ã¯ç”»åƒç´ æã‚’ä½¿ã‚ãšã€Unicodeçµµæ–‡å­—ã®ã¿ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚å‹•ä½œãŒè»½ãã€ç•°ãªã‚‹ãƒ‡ãƒã‚¤ã‚¹ã‚„OSé–“ã§ã‚‚é«˜ã„äº’æ›æ€§ãŒã‚ã‚Šã€ãƒ•ã‚¡ã‚¤ãƒ«ã®ç ´æã‚‚èµ·ãã«ãã„è¨­è¨ˆã§ã™ã€‚</li>
                        <li style="color:#d32f2f;"><strong>âš ï¸ æ³¨æ„ç‚¹</strong><br>æœ¬ãƒ„ãƒ¼ãƒ«ã¯ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’ç”¨ã®ãŸã‚ã€ç‰©ç†ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§ã®æ“ä½œã‚’å‰æã¨ã—ã¦ã„ã¾ã™ã€‚ç”»é¢ä¸Šã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼ˆã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼‰ã«ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚</li>
                    </ul>

                    <div class="license-box">
                        å•†ç”¨åˆ©ç”¨ã¯ä¸å¯ã§ã™ãŒã€é…å¸ƒãƒ»åˆ©ç”¨ãƒ»æ”¹å¤‰ã¯è‡ªç”±ã§ã™ã€‚<br>
                        (Non-commercial use only. Free to distribute, use, and modify)
                    </div>
                </div>
            </div>

            <div id="overlay">
                <div id="title-area">
                    <h1 id="title-text">ãƒ­ãƒ¼ãƒå­—ã‚¿ã‚¤ãƒ”ãƒ³ã‚°<span class="subtitle">ï¼ˆ1ã‚‚ã˜ã¨ã£ãã‚“ï¼‰</span></h1>
                    <button class="btn-howto" onclick="showHowto()">ğŸ“– ã‚ãã³ã‹ãŸãƒ»ã›ã¤ã‚ã„</button>
                </div>
                
                <div id="menu-content" class="menu-wrapper">
                    <div class="settings-panel">
                        <div>
                            <div class="panel-label">â­ ã‚€ãšã‹ã—ã• (Lv)</div>
                            <div class="level-selector">
                                <div class="lvl-btn" onclick="selectLevel(0)" id="lvl-btn-0">
                                    <span class="lvl-icon">ğŸ”°</span>
                                    <span class="lvl-name">Lv0<br>ã‚ã„ã†ãˆãŠ</span>
                                </div>
                                <div class="lvl-btn selected" onclick="selectLevel(1)" id="lvl-btn-1">
                                    <span class="lvl-icon">ğŸ£</span>
                                    <span class="lvl-name">Lv1<br>ã‚ã€œã‚“</span>
                                </div>
                                <div class="lvl-btn" onclick="selectLevel(2)" id="lvl-btn-2">
                                    <span class="lvl-icon">ğŸ¥</span>
                                    <span class="lvl-name">Lv2<br>ï¼‹ã ããŠã‚“</span>
                                </div>
                                <div class="lvl-btn" onclick="selectLevel(3)" id="lvl-btn-3">
                                    <span class="lvl-icon">ğŸ¦…</span>
                                    <span class="lvl-name">Lv3<br>ï¼‹ã¡ã„ã•ã„å­—</span>
                                </div>
                            </div>
                            <input type="hidden" id="level-slider" value="1">
                        </div>

                        <div>
                            <div class="panel-label">ğŸ…°ï¸ ã²ã‚‡ã†ã˜ã™ã‚‹ ã‚‚ã˜</div>
                            <div class="case-selector">
                                <div style="display:flex; align-items:center; gap:10px; cursor:pointer;" onclick="toggleCase()">
                                    <span class="switch-label" id="label-lower">abc</span>
                                    <div class="toggle-switch" id="case-switch-ui"></div>
                                    <span class="switch-label" id="label-upper">ABC</span>
                                    <input type="checkbox" id="case-switch" style="display:none">
                                </div>
                                <button class="reset-btn" onclick="resetRankings(event)" title="ãã‚ãã‚’ã‘ã™">ğŸ—‘ï¸</button>
                            </div>
                        </div>

                        <div class="sound-panel">
                            <label style="flex:1; display:flex; align-items:center; justify-content:space-between; cursor:pointer;">
                                <span style="font-weight:bold; color:#555; font-size:1.0rem; display:flex; align-items:center;">
                                    <span style="font-size:1.3rem; margin-right:5px;">ğŸ”Š</span> ãŠã¨
                                </span>
                                <input type="checkbox" id="sound-switch" checked style="transform:scale(1.4); accent-color:var(--primary-color); cursor:pointer;" onchange="toggleSoundMenu()">
                            </label>
                        </div>

                        <div>
                            <div class="panel-label">â° ã‚‚ãã²ã‚‡ã†ã‚¿ã‚¤ãƒ </div>
                            <select id="target-time-select" onchange="saveTargetSetting()">
                                <option value="9999">ãªã— (ã‚Œã‚“ã—ã‚…ã†)</option>
                                <option value="180">3ãµã‚“ (ã‚†ã£ãã‚Š)</option>
                                <option value="120">2ãµã‚“ (ãµã¤ã†)</option>
                                <option value="90">1ãµã‚“30ã³ã‚‡ã† (ã‚„ã‚‹ã­)</option>
                                <option value="60">1ãµã‚“ (ã¯ã‚„ã„ï¼)</option>
                                <option value="40">40ã³ã‚‡ã† (ã‹ãªã‚Šã™ã”ã„)</option>
                                <option value="30">30ã³ã‚‡ã† (ã‚ã£ã¡ã‚ƒï¼ã™ã”ã„ï¼)</option>
                            </select>
                        </div>
                    </div>

                    <div class="modes-panel">
                        <button class="mode-card random" onclick="startGame(this, 'random')">
                            <span class="mode-icon">ğŸ²</span>
                            <div class="mode-text">
                                <span class="mode-title">ãƒãƒ©ãƒãƒ©</span>
                                <span class="mode-desc">ã‚‚ã‚“ã ã„ãŒ ãƒãƒ©ãƒãƒ©ã« ã§ã‚‹ã‚ˆï¼<br>(ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼)</span>
                            </div>
                        </button>
                        <button class="mode-card order" onclick="startGame(this, 'order')">
                            <span class="mode-icon">ğŸ“</span>
                            <div class="mode-text">
                                <span class="mode-title">ã‚ã„ã†ãˆãŠ ã˜ã‚…ã‚“</span>
                                <span class="mode-desc">ã˜ã‚…ã‚“ã°ã‚“ã« ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã—ã‚ˆã†ï¼<br>(ãƒã‚¦ã‚¹ã§ãŠã—ã¦ã­)</span>
                            </div>
                        </button>
                    </div>
                </div>

                <div id="footer-area">
                    <div class="mini-rank">
                        <strong>ğŸ² ãƒãƒ©ãƒãƒ© ãƒ™ã‚¹ãƒˆ3:</strong> <span id="rank-random">ãƒ¼</span>
                    </div>
                    <div class="mini-rank" style="border-color:#bae6fd;">
                        <strong style="color:#0288d1">ğŸ“ ã‚ã„ã†ãˆãŠ ãƒ™ã‚¹ãƒˆ3:</strong> <span id="rank-order">ãƒ¼</span>
                    </div>
                </div>
                
                <div class="copyright-link" onclick="showConcept()">Â© 2026 [A.K] (ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°)</div>

                <div id="result-content">
                    <div id="result-message"></div>
                    <button class="btn-retry" onclick="resetToMenu()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã‚‚ã©ã‚‹</button>
                    <div style="margin-top:15px; color:#888; font-size:1.1rem;">(ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ ã‚‚ã†ã„ã¡ã©)</div>
                </div>
            </div>

            <div class="info-bar">
                <div class="remain-box">ã®ã“ã‚Š: <span id="remain">0</span></div>
                <div class="timer-box" id="timer">0.0ã³ã‚‡ã†</div>
                <div class="top-icons">
                    <div class="icon-btn" onclick="toggleSoundGame()" id="icon-sound" title="ãŠã¨ã®ON/OFF">ğŸ”Š</div>
                    <div class="icon-btn" onclick="toggleFullscreen()" id="icon-fullscreen" title="å…¨ç”»é¢">â›¶</div>
                </div>
            </div>

            <div id="display-area">
                <div id="target-kana">ã‚</div>
                <div id="target-roma">A</div>
            </div>

            <div id="keyboard"></div>
        </div>
    </div>

    <script>
        // --- ãƒ‡ãƒ¼ã‚¿å®šç¾© ---
        const baseKana = {
            "ã‚": ["A"], "ã„": ["I"], "ã†": ["U"], "ãˆ": ["E"], "ãŠ": ["O"],
            "ã‹": ["KA"], "ã": ["KI"], "ã": ["KU"], "ã‘": ["KE"], "ã“": ["KO"],
            "ã•": ["SA"], "ã—": ["SI", "SHI"], "ã™": ["SU"], "ã›": ["SE"], "ã": ["SO"],
            "ãŸ": ["TA"], "ã¡": ["TI", "CHI"], "ã¤": ["TU", "TSU"], "ã¦": ["TE"], "ã¨": ["TO"],
            "ãª": ["NA"], "ã«": ["NI"], "ã¬": ["NU"], "ã­": ["NE"], "ã®": ["NO"],
            "ã¯": ["HA"], "ã²": ["HI"], "ãµ": ["HU", "FU"], "ã¸": ["HE"], "ã»": ["HO"],
            "ã¾": ["MA"], "ã¿": ["MI"], "ã‚€": ["MU"], "ã‚": ["ME"], "ã‚‚": ["MO"],
            "ã‚„": ["YA"], "ã‚†": ["YU"], "ã‚ˆ": ["YO"],
            "ã‚‰": ["RA"], "ã‚Š": ["RI"], "ã‚‹": ["RU"], "ã‚Œ": ["RE"], "ã‚": ["RO"],
            "ã‚": ["WA"], "ã‚’": ["WO"], "ã‚“": ["NN"]
        };
        const dakutenKana = {
            "ãŒ": ["GA"], "ã": ["GI"], "ã": ["GU"], "ã’": ["GE"], "ã”": ["GO"],
            "ã–": ["ZA"], "ã˜": ["ZI", "JI"], "ãš": ["ZU"], "ãœ": ["ZE"], "ã": ["ZO"],
            "ã ": ["DA"], "ã¢": ["DI", "JI"], "ã¥": ["DU", "ZU"], "ã§": ["DE"], "ã©": ["DO"],
            "ã°": ["BA"], "ã³": ["BI"], "ã¶": ["BU"], "ã¹": ["BE"], "ã¼": ["BO"],
            "ã±": ["PA"], "ã´": ["PI"], "ã·": ["PU"], "ãº": ["PE"], "ã½": ["PO"]
        };
        const yoonKana = {
            "ãã‚ƒ": ["KYA"], "ãã‚…": ["KYU"], "ãã‚‡": ["KYO"], "ã—ã‚ƒ": ["SYA", "SHA"], "ã—ã‚…": ["SYU", "SHU"], "ã—ã‚‡": ["SYO", "SHO"],
            "ã¡ã‚ƒ": ["TYA", "CHA"], "ã¡ã‚…": ["TYU", "CHU"], "ã¡ã‚‡": ["TYO", "CHO"], "ã«ã‚ƒ": ["NYA"], "ã«ã‚…": ["NYU"], "ã«ã‚‡": ["NYO"],
            "ã²ã‚ƒ": ["HYA"], "ã²ã‚…": ["HYU"], "ã²ã‚‡": ["HYO"], "ã¿ã‚ƒ": ["MYA"], "ã¿ã‚…": ["MYU"], "ã¿ã‚‡": ["MYO"],
            "ã‚Šã‚ƒ": ["RYA"], "ã‚Šã‚…": ["RYU"], "ã‚Šã‚‡": ["RYO"], "ãã‚ƒ": ["GYA"], "ãã‚…": ["GYU"], "ãã‚‡": ["GYO"],
            "ã˜ã‚ƒ": ["JA", "JYA", "ZYA"], "ã˜ã‚…": ["JU", "JYU", "ZYU"], "ã˜ã‚‡": ["JO", "JYO", "ZYO"],
            "ã³ã‚ƒ": ["BYA"], "ã³ã‚…": ["BYU"], "ã³ã‚‡": ["BYU"], "ã´ã‚ƒ": ["PYA"], "ã´ã‚…": ["PYU"], "ã´ã‚‡": ["PYO"]
        };

        // --- å¤‰æ•° ---
        let currentDict = {};
        let questions = [];
        let curIdx = 0;
        let typedString = ""; 
        let startTime, isPlaying = false, gameMode = '';
        let timerInterval;
        let targetTime = 9999;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let isSoundOn = true; // éŸ³ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

        // --- åˆæœŸåŒ–: ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ç”Ÿæˆ ---
        const kb = document.getElementById('keyboard');
        const rows = ["QWERTYUIOP", "ASDFGHJKL", "ZXCVBNM"];
        rows.forEach(rowString => {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'kb-row';
            rowString.split("").forEach(k => {
                const div = document.createElement('div');
                div.className = 'key' + (k==='F'||k==='J' ? ' home' : '');
                div.id = `key-${k}`;
                div.innerText = k;
                rowDiv.appendChild(div);
            });
            kb.appendChild(rowDiv);
        });

        // è¨­å®šèª­ã¿è¾¼ã¿
        if(localStorage.getItem('typing_target_time')) {
            document.getElementById('target-time-select').value = localStorage.getItem('typing_target_time');
        }
        
        // éŸ³è¨­å®šã®èª­ã¿è¾¼ã¿
        if(localStorage.getItem('typing_sound_config') !== null) {
            isSoundOn = (localStorage.getItem('typing_sound_config') === 'true');
        }
        updateSoundUI(); // UIåæ˜ 

        // --- UIæ“ä½œé–¢æ•° ---
        // ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
        function showHowto() {
            document.getElementById('modal-howto-overlay').style.display = 'flex';
        }
        function showConcept() {
            document.getElementById('modal-concept-overlay').style.display = 'flex';
        }
        function closeModalBtn() {
            document.querySelectorAll('.modal-overlay').forEach(e => e.style.display = 'none');
        }
        function closeModal(e) {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.style.display = 'none';
            }
        }

        function selectLevel(lv) {
            document.getElementById('level-slider').value = lv;
            
            // ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«æ›´æ–°
            for(let i=0; i<=3; i++){
                const btn = document.getElementById(`lvl-btn-${i}`);
                if(btn) {
                    if(i === lv) btn.classList.add('selected');
                    else btn.classList.remove('selected');
                }
            }
            
            // Lv0ã®å ´åˆã®ç‰¹åˆ¥å‡¦ç†ï¼ˆç›®æ¨™ã‚¿ã‚¤ãƒ å›ºå®šãƒ»ç„¡åŠ¹åŒ–ï¼‰
            const timeSelect = document.getElementById('target-time-select');
            if (lv === 0) {
                // ä¸€æ™‚çš„ã«ä¿å­˜
                if(!timeSelect.disabled) localStorage.setItem('typing_target_time_temp', timeSelect.value);
                
                timeSelect.value = "9999"; 
                timeSelect.disabled = true;
            } else {
                if (timeSelect.disabled) {
                    timeSelect.disabled = false;
                    // å¾©å…ƒã¾ãŸã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰
                    const temp = localStorage.getItem('typing_target_time_temp');
                    const saved = localStorage.getItem('typing_target_time');
                    if(temp) timeSelect.value = temp;
                    else if(saved) timeSelect.value = saved;
                }
            }

            showRankings(); 
        }

        function toggleCase() {
            const chk = document.getElementById('case-switch');
            chk.checked = !chk.checked;
            applyCaseUI();
        }

        function applyCaseUI() {
            const chk = document.getElementById('case-switch');
            const ui = document.getElementById('case-switch-ui');
            const lblL = document.getElementById('label-lower');
            const lblU = document.getElementById('label-upper');

            if(chk.checked) {
                ui.classList.add('on');
                lblU.classList.add('active');
                lblL.classList.remove('active');
            } else {
                ui.classList.remove('on');
                lblL.classList.add('active');
                lblU.classList.remove('active');
            }
            updateKeyLabels();
        }

        // éŸ³è¨­å®šã®åˆ‡ã‚Šæ›¿ãˆï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”¨ï¼šãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆï¼‰
        function toggleSoundMenu() {
            const chk = document.getElementById('sound-switch');
            isSoundOn = chk.checked;
            localStorage.setItem('typing_sound_config', isSoundOn);
            updateSoundUI();
        }
        
        // éŸ³è¨­å®šã®åˆ‡ã‚Šæ›¿ãˆï¼ˆã‚²ãƒ¼ãƒ å†…ã‚¢ã‚¤ã‚³ãƒ³ç”¨ï¼‰
        function toggleSoundGame() {
            isSoundOn = !isSoundOn;
            localStorage.setItem('typing_sound_config', isSoundOn);
            updateSoundUI();
        }

        // éŸ³UIã®åŒæœŸæ›´æ–°
        function updateSoundUI() {
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å´ (ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹)
            const chk = document.getElementById('sound-switch');
            if(chk) chk.checked = isSoundOn;

            // ã‚²ãƒ¼ãƒ ç”»é¢ã‚¢ã‚¤ã‚³ãƒ³å´
            const icon = document.getElementById('icon-sound');
            if (isSoundOn) {
                icon.innerText = "ğŸ”Š";
                icon.style.opacity = "1";
            } else {
                icon.innerText = "ğŸ”‡";
                icon.style.opacity = "0.6";
            }
        }

        // å…¨ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e => {
                    console.log("Fullscreen failed", e);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // åˆæœŸè¡¨ç¤ºç”¨
        applyCaseUI();
        selectLevel(1);

        function saveTargetSetting() {
            const val = document.getElementById('target-time-select').value;
            localStorage.setItem('typing_target_time', val);
        }

        function playTone(freq, type, duration) {
            if (!isSoundOn) return; // éŸ³OFFãªã‚‰å†ç”Ÿã—ãªã„
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.value = freq;
            osc.connect(gain); gain.connect(audioCtx.destination);
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }

        function startGame(btn, mode) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            if(btn) btn.blur(); 

            isPlaying = true; gameMode = mode;
            curIdx = 0; typedString = ""; startTime = Date.now();
            
            const level = parseInt(document.getElementById('level-slider').value);
            targetTime = parseInt(document.getElementById('target-time-select').value);

            currentDict = { ...baseKana };
            
            if (level === 0) {
                // Lv0: ã‚ã„ã†ãˆãŠå›ºå®š (5ç¨®)
                const aiueo = ["ã‚", "ã„", "ã†", "ãˆ", "ãŠ"];
                
                if (mode === 'order') {
                     // é †ç•ªé€šã‚Š5ã‚»ãƒƒãƒˆ
                    let qList = [];
                    for(let i=0; i<5; i++) qList.push(...aiueo);
                    questions = qList;
                } else {
                    // ãƒ©ãƒ³ãƒ€ãƒ : ç›´å‰ã¨åŒã˜æ–‡å­—ãŒå‡ºãªã„ã‚ˆã†ã«25å•ç”Ÿæˆ
                    questions = [];
                    let lastChar = "";
                    for(let i=0; i<25; i++) {
                        // ç›´å‰ã¨é•ã†æ–‡å­—ã®å€™è£œãƒªã‚¹ãƒˆã‚’ä½œæˆ
                        const candidates = aiueo.filter(c => c !== lastChar);
                        // ãã“ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸ã¶
                        const nextChar = candidates[Math.floor(Math.random() * candidates.length)];
                        questions.push(nextChar);
                        lastChar = nextChar;
                    }
                }
            } else {
                // Lv1ä»¥ä¸Š
                if (level >= 2) Object.assign(currentDict, dakutenKana);
                if (level >= 3) Object.assign(currentDict, yoonKana);

                const keysArr = Object.keys(currentDict);
                
                if (mode === 'order') {
                    questions = keysArr; 
                } else {
                    // ãƒ©ãƒ³ãƒ€ãƒ : ã¾ãšã‚·ãƒ£ãƒƒãƒ•ãƒ«
                    let qList = [...keysArr].sort(() => Math.random() - 0.5).slice(0, 50);
                    
                    // é€£ç¶šãƒã‚§ãƒƒã‚¯ã¨ä¿®æ­£ï¼ˆå¿µã®ãŸã‚ï¼‰
                    for(let i=1; i<qList.length; i++) {
                        if(qList[i] === qList[i-1]) {
                            // ã‚‚ã—è¢«ã£ãŸã‚‰ã€é…åˆ—ã®åˆ¥ã®å ´æ‰€ã¨å…¥ã‚Œæ›¿ãˆã¦ã¿ã‚‹ï¼ˆç°¡æ˜“å¯¾å‡¦ï¼‰
                            const swapIdx = (i + 1) % qList.length;
                            [qList[i], qList[swapIdx]] = [qList[swapIdx], qList[i]];
                        }
                    }
                    questions = qList;
                }
            }
            
            document.body.className = mode === 'order' ? 'order-mode' : '';
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼éè¡¨ç¤º
            document.getElementById('menu-content').style.display = "none";
            document.getElementById('footer-area').style.display = "none";
            document.getElementById('title-area').style.display = "none";
            
            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å…¨ä½“ã‚’éè¡¨ç¤º
            document.getElementById('overlay').style.display = "none";
            document.getElementById('result-content').style.display = "none";
            
            updateKeyLabels();
            nextQuestion();
            
            timerInterval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;
                document.getElementById('timer').innerText = elapsed.toFixed(1) + "ã³ã‚‡ã†";
            }, 100);
        }

        function nextQuestion() {
            if (curIdx >= questions.length) return endGame();
            typedString = "";
            updateDisplay();
        }

        function updateKeyLabels() {
            const isUpper = document.getElementById('case-switch').checked;
            document.querySelectorAll('.key').forEach(k => {
                const base = k.id.split('-')[1];
                k.innerText = isUpper ? base : base.toLowerCase();
            });
            if(isPlaying) updateDisplay();
        }

        function updateDisplay() {
            const currentKana = questions[curIdx];
            const validSpellings = currentDict[currentKana];
            const isUpper = document.getElementById('case-switch').checked;
            
            const candidates = validSpellings.filter(roma => roma.startsWith(typedString));
            const targetRoma = candidates.length > 0 ? candidates[0] : validSpellings[0];

            document.getElementById('target-kana').innerText = currentKana;
            document.getElementById('remain').innerText = questions.length - curIdx;

            let html = "";
            for(let i=0; i < targetRoma.length; i++) {
                let char = isUpper ? targetRoma[i] : targetRoma[i].toLowerCase();
                if(i < typedString.length) {
                    html += `<span class="typed">${char}</span>`;
                } else if(i === typedString.length) {
                    html += `<span class="next-char">${char}</span>`;
                } else {
                    html += `<span>${char}</span>`;
                }
            }
            document.getElementById('target-roma').innerHTML = html;

            document.querySelectorAll('.key').forEach(k => k.classList.remove('active'));
            if(targetRoma[typedString.length]) {
                const nextKeyChar = targetRoma[typedString.length];
                document.getElementById(`key-${nextKeyChar}`).classList.add('active');
            }
        }

        function resetToMenu() {
            document.getElementById('overlay').style.display = "flex";
            document.getElementById('menu-content').style.display = "flex";
            document.getElementById('footer-area').style.display = "flex";
            document.getElementById('title-area').style.display = "block";
            document.getElementById('result-content').style.display = "none";
            showRankings();
        }

        function quitGame() {
            clearInterval(timerInterval);
            isPlaying = false;
            resetToMenu();
        }

        window.addEventListener('keydown', (e) => {
            if (e.key === "Escape") { 
                const howto = document.getElementById('modal-howto-overlay');
                const concept = document.getElementById('modal-concept-overlay');
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (howto.style.display === 'flex' || concept.style.display === 'flex') {
                    closeModalBtn(); // é–‰ã˜ã‚‹
                } else {
                    quitGame(); // ã‚²ãƒ¼ãƒ ä¸­æ–­
                }
                return; 
            }

            if (e.code === "Space" || e.key === " ") {
                e.preventDefault();
                if (!isPlaying) {
                    if (document.getElementById('result-content').style.display === "flex") {
                        startGame(null, gameMode);
                    } else if(document.getElementById('menu-content').style.display !== "none") {
                        startGame(null, 'random');
                    }
                }
                return;
            }

            if (!isPlaying || e.key === "Shift" || e.ctrlKey || e.altKey || e.metaKey) return;
            
            // IMEå…¥åŠ›ä¸­ã§ã‚‚åå¿œã™ã‚‹ã‚ˆã†ã« e.code ã‚‚ãƒã‚§ãƒƒã‚¯
            let inputKey = null;

            // 1. é€šå¸¸ã®è‹±æ•°å­—å…¥åŠ›
            if (/^[a-zA-Z0-9-]$/.test(e.key)) {
                inputKey = e.key.toUpperCase();
            } 
            // 2. IMEå…¥åŠ›ä¸­ãªã© (e.keyãŒ 'Process' ã‚„ 'ã‚' ã«ãªã‚‹å ´åˆ)
            else if (e.code.startsWith('Key')) {
                // KeyA -> A, KeyZ -> Z ã®ã‚ˆã†ã«å–å¾—
                inputKey = e.code.slice(3).toUpperCase();
            }
            else if (e.code === 'Minus') {
                inputKey = '-';
            }

            if (!inputKey) return; // åˆ¤å®šã§ããªã„ã‚­ãƒ¼ã¯ç„¡è¦–

            const currentKana = questions[curIdx];
            const validSpellings = currentDict[currentKana];
            const nextString = typedString + inputKey;
            
            if (validSpellings.some(roma => roma.startsWith(nextString))) {
                typedString = nextString;
                playTone(880, 'sine', 0.05);

                if (validSpellings.includes(typedString)) {
                    curIdx++;
                    playTone(523, 'sine', 0.1);
                    nextQuestion();
                } else {
                    updateDisplay();
                }
            } else {
                playTone(150, 'sawtooth', 0.2);
                const container = document.getElementById('game-container');
                container.classList.remove('shake');
                void container.offsetWidth;
                container.classList.add('shake');
            }
        });

        function saveRecord(mode, time) {
            const level = document.getElementById('level-slider').value;
            // Lv0ã¯ä¿å­˜ã—ãªã„
            if (level == 0) return;

            const key = `typing_rank_${mode}_lv${level}`;
            let scores = JSON.parse(localStorage.getItem(key)) || [];
            scores.push(time);
            scores.sort((a, b) => a - b);
            localStorage.setItem(key, JSON.stringify(scores.slice(0, 3)));
        }

        function showRankings() {
            const level = document.getElementById('level-slider').value;
            ['random', 'order'].forEach(mode => {
                if (level == 0) {
                    document.getElementById(`rank-${mode}`).innerHTML = 
                        "<span style='margin-left:8px; color:#aaa; font-size:0.8em'>Lv0ã¯ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãªã—</span>";
                } else {
                    const key = `typing_rank_${mode}_lv${level}`;
                    const scores = JSON.parse(localStorage.getItem(key)) || [];
                    const html = scores.length ? scores.map((s, i) => 
                        `<span style="margin-left:8px; font-weight:normal;">${i+1}ã„ ${s.toFixed(1)}ã³ã‚‡ã†</span>`
                    ).join('') : "<span style='margin-left:8px; color:#aaa;'>ã¾ã ãªã„ã‚ˆ</span>";
                    document.getElementById(`rank-${mode}`).innerHTML = html;
                }
            });
        }
        
        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½
        function resetRankings(e) {
            e.stopPropagation(); // è¦ªè¦ç´ ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆtoggleCaseï¼‰ã‚’æ­¢ã‚ã‚‹
            if(confirm("ã™ã¹ã¦ã® ãƒ¬ãƒ™ãƒ«ã® ãã‚ãã‚’\nãƒªã‚»ãƒƒãƒˆï¼ˆã•ãã˜ã‚‡ï¼‰ã—ã¦ã‚‚ ã„ã„ã§ã™ã‹ï¼Ÿ")) {
                const modes = ['random', 'order'];
                const levels = [1, 2, 3]; // Lv0ã¯ä¿å­˜ã•ã‚Œãªã„ã®ã§å¯¾è±¡å¤–
                modes.forEach(m => {
                    levels.forEach(lv => {
                        localStorage.removeItem(`typing_rank_${m}_lv${lv}`);
                    });
                });
                showRankings();
                alert("ãã‚ãã‚’ ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
            }
        }
        
        function endGame() {
            clearInterval(timerInterval);
            isPlaying = false;
            const finalTime = (Date.now() - startTime) / 1000;
            saveRecord(gameMode, finalTime);

            document.getElementById('overlay').style.display = "flex";
            document.getElementById('result-content').style.display = "flex";

            let msg = `<div>ã‚¿ã‚¤ãƒ : <span style="font-size:4rem; font-weight:bold; color:var(--primary-color)\">${finalTime.toFixed(1)}ã³ã‚‡ã†</span></div>`;
            
            // Lv0ã®å ´åˆã¯ç›®æ¨™ã‚¿ã‚¤ãƒ åˆ¤å®šã‚’è¡Œã‚ãªã„
            const level = document.getElementById('level-slider').value;
            if (level == 0) {
                 msg += `<div class="stamp" style="border-color:#66bb6a; color:#2e7d32;">Practice Finish!</div>`;
            } else if (targetTime !== 9999) {
                if (finalTime <= targetTime) {
                    playTone(600, 'sine', 0.1); setTimeout(()=>playTone(800, 'sine', 0.2), 150);
                    msg += `<div class="stamp">ğŸ’® ã‚‚ãã²ã‚‡ã† ã‚¯ãƒªã‚¢ï¼</div>`;
                } else {
                    msg += `<div style=\"margin-top:10px; color:#555; font-size:1.4rem\\\">ã‚ã¨ ${(finalTime - targetTime).toFixed(1)}ã³ã‚‡ã†ã§ ã‚¯ãƒªã‚¢ï¼</div>`;
                }
            } else {
                msg += `<div class="stamp" style="border-color:orange; color:orange;">FINISH!</div>`;
            }
            document.getElementById('result-message').innerHTML = msg;
        }

        showRankings();
    </script>
</body>
</html>